<div class="container-md">
    <!-- session header -->
    <div *ngIf="session" class="row bg-light mt-2 mb-3 p-3 justify-content-around align-items-center">
        <div class="col-4">
            saison : {{session.season}}
        </div>
        <div class="col-5">
            {{session.vendor}}
        </div>
        <div class="col-3">
            <div class=" input-group input-group-sm">
                <span class="input-group-text">date de vente</span>
                <input type="date" class="form-control" (ngModelChange)="renew_session()" [(ngModel)]="session.event">
                <!-- <button class="btn btn-sm btn-outline-primary" (click)="renew_session()">Autre date</button> -->
            </div>
        </div>
    </div>

    <!-- sale editor -->
    <div *ngIf="session" class="row ">
        <div class="row">
            <!-- product keypad -->
            <div class="col-3 mt-2">
                <div class="row">

                    <div class="col-8 gx-2">
                        <div class="row" *ngFor="let category of product_keys | keyvalue">
                            <div class="card-group">
                                <div *ngFor="let product of category.value"
                                    class="card text-white bg-primary nice_shadow  bigger-on-hover"
                                    (click)="productSelected(product)">
                                    <div class="card-body text-center px-0 py-1">
                                        <strong>{{product.glyph}}</strong>
                                        <p>
                                            <small>{{product.price.toFixed(2)}} €</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- payment keys -->
                    <div class="col-4 gx-2">
                        <ng-container class="row" *ngFor="let paymode of paymodes">
                            <div [class]=" paymode.class ">
                                <div (click)="paymode_selected(paymode)" class="card-body text-center px-0 py-1">
                                    <strong>{{paymode.glyph}}</strong>
                                    <p><i [class]="paymode.icon"></i> </p>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </div>
            </div>
            <!-- cart -->
            <div class="col-5 mt-2  fst-italic fst-light fs-6 font-monospace ">

                <!-- buyer -->
                <div class="row mb-2 p-2">
                    <div [formGroup]="payeesForm" class="row align-items-center ">
                        <div class="col-auto"><strong> Acheteur</strong> </div>
                        <div class="col-6">
                            <app-input-member class="form-control form-control-sm" [members]="members"
                                formControlName="payee_1"></app-input-member>
                        </div>
                    </div>
                </div>
                <!-- cart details -->
                <div class="row mb-2 p-2">
                    <app-cart [(valid)]="cart_is_valid"></app-cart>
                </div>
                <div *ngIf="getTotal() !==0" class="mb-2 p-2">
                    <!-- price  -->
                    <div class="row">
                        <div class="col col-md-5 align-self-center">
                            <span class="fw-bold">Total à régler</span>
                        </div>
                        <div class="offset-4 col col-md-2 text-end align-self-center">
                            <span class="fw-bold">{{getTotal() | currency:'€':'symbol':'2.2-2':'fr'}}</span>
                        </div>
                    </div>
                    <!--  payment details -->
                    <div *ngIf="sale" class="row mt-2">
                        <span>
                            <strong>Mode de paiement :</strong>
                            {{sale.payment.payment_mode}}
                        </span>
                        <ng-container *ngIf="sale.payment.payment_mode === paymentMode.CHEQUE"
                            [ngTemplateOutlet]="get_check_ref">
                        </ng-container>

                    </div>
                    <!-- validation -->
                    <div *ngIf="sale" class="row px-2 mt-2">
                        <button [disabled]="sale.payment.payment_mode === paymentMode.CHEQUE && !checkForm.valid"
                            class="btn btn-success nice_shadow" (click)="valid_sale(sale)">confirmation</button>
                    </div>
                </div>
            </div>
            <!--  sales_of_the_day -->
            <div class="col-md-4 mt-4 fst-italic fst-light fs-6 font-monospace bg-body-tertiary">
                <strong>encaissements : </strong>
                <table class="table table-striped  table-borderless table-primary align-middle">
                    <tr *ngFor="let sale of sales_of_the_day$ | async">
                        <td>{{member_name(sale.payer_id)}}</td>
                        <td class="text-end">{{sale.amount | currency:'€':'symbol':'2.2-2':'fr'}}</td>
                        <td>{{sale.payment.payment_mode}}</td>
                    </tr>
                </table>
            </div>
        </div>



    </div>
    <ng-template #get_check_ref>
        <form [formGroup]="checkForm">
            <div class="row flex-row align-items-end">
                <div class="col-4 px-2">
                    <label for="bank" class="form-label">Banque</label>
                    <select list="banks" type="text" id="bank_names" class="form-select form-select-sm"
                        formControlName="bank">
                        <option id="bank_names" *ngFor="let bank of banks$ | async " [value]="bank.key">
                            {{bank.name}}
                        </option>
                    </select>
                    <div *ngIf="bank.touched && bank.invalid " class="text-danger">
                        le nom de la banque doit être renseigné.
                    </div>
                </div>
                <div class="col-4 px-2">
                    <label for="cheque_no" class="form-label">N° Chèque</label>
                    <input type="text" id="cheque_no" class="form-control form-control-sm" formControlName="cheque_no">
                    <div *ngIf="cheque_no.touched && cheque_no.invalid " class="text-danger">
                        <span *ngIf="cheque_no.errors?.['required']">le n° de chèque doit être renseigné. </span>
                        <span *ngIf="cheque_no.errors?.['pattern']">le n° de chèque doit avoir 6 digits. </span>
                    </div>
                </div>
                <div class="col-4">

                </div>
            </div>
        </form>
    </ng-template>
    <!-- <div *ngIf="event === null">
    fin de session de saisie : pour redémarrer une session cliquer sur Vente dans la barre de menue
</div> -->