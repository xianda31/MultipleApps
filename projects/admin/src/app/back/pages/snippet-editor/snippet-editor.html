<form [formGroup]="form">

    <h6 class="mt-1"><i class="bi bi-gear-fill me-2"></i>Contenu</h6>
    <div class="row">
        <div class="col-8">
            <label class="form-label form-label-sm mb-0">Titre</label>
            <input type="text" formControlName="title" class="form-control form-control-sm mb-1"
                (keydown.enter)="saveSnippetSelected()">
            <label class="form-label form-label-sm mb-0">Sous-titre</label>
            <input type="text" formControlName="subtitle" class="form-control form-control-sm text-muted mb-1"
                (keydown.enter)="saveSnippetSelected()">
        </div>
        <div class="col-4 text-center">
            <img *ngIf="form.get('image')?.value" [src]="snippet?.image_url || form.get('image')?.value"
                alt="{{ form.get('title')?.value }}" class="img-fluid snippet-img-limited">
        </div>
    </div>

    <div class="form-label text-muted mb-0 mt-2">
        <button class="btn btn-sm btn-outline-success " (click)="snippet && onSnippetContentClick(snippet)">
            <i class="bi bi-arrows-fullscreen"></i> Éditeur texte </button>
    </div>

    <h6 class="mt-3"><i class="bi bi-gear-fill me-2"></i>Paramètres de publication</h6>

    <div class="mt-2 d-flex flex-row align-items-center gap-3">
        <span class="form-label text-muted mb-0">Publié le (sinon aujourd'hui):</span>
        <input type="date" formControlName="publishedAt" class="form-control form-control-sm d-inline-block w-auto"
            (keydown.enter)="saveSnippetSelected()" placeholder="publication">
    </div>

    <div class="mt-2 d-flex flex-row align-items-center gap-3">
        <div class="form-check form-switch mb-0 d-flex flex-row align-items-center">
            <input [formControlName]="'public'" (change)="onToggleChange('public', $event.target.checked)"
                [ngClass]="form.get('public')?.value ? 'bg-success' : 'bg-light'" class="form-check-input"
                style="width: 3em; height: 1.5em;" type="checkbox" role="switch">
            <label class="form-check-label text-muted ms-2">Public</label>
        </div>
        <div class="form-check form-switch mb-0 d-flex flex-row align-items-center">
            <input [formControlName]="'featured'" (change)="onToggleChange('featured', $event.target.checked)"
                [ngClass]="form.get('featured')?.value ? 'bg-success' : 'bg-light'" class="form-check-input"
                style="width: 3em; height: 1.5em;" type="checkbox" role="switch">
            <label class="form-check-label text-muted ms-2">à la une</label>
        </div>
    </div>


    <h6 class="mt-3"><i class="bi bi-gear-fill me-2"></i>Fichiers associés</h6>
    <ng-container *ngIf="showImageSelector">
        <ng-container *ngTemplateOutlet="imageSelector"></ng-container>
    </ng-container>

    <!-- image url input -->
    <div class="form-label mb-0 mt-2">
        Image associée :
        <span class="form-text">{{ form.get('image')?.value || 'aucune image' }}
        </span>
        <button class=" ms-1 btn btn-sm " (click)="openImageSelector()" >
            <i class="bi bi-image"></i>
        </button>
    </div>


    <!-- file url input -->
    <div class="form-text mb-0 mt-2">Fichier à télécharger (template "téléchargement")</div>
    <div class="input-group input-group-sm ">
        <span class="input-group-text" style="min-width: 110px;">Fichier</span>
        <input type="text" list="file_datalist" class="form-control" [placeholder]="form.get('file')?.value"
            formControlName="file" (keydown.enter)="saveSnippetSelected()" (change)="saveSnippetSelected()">

        <datalist id="file_datalist">
            <option *ngFor="let path of file_paths$ | async" [value]="path">
                {{ path }}
            </option>
        </datalist>

        <button class="btn btn-sm " (click)="form.get('file')?.setValue(''); saveSnippetSelected();">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>


    <!-- folder url input -->
    <div class="form-text mb-0 mt-2">Pour album photo</div>
    <div class="input-group input-group-sm ">
        <span class="input-group-text" style="min-width: 110px;">Dossier</span>
        <input type="text" list="folder_datalist" class="form-control" [placeholder]="form.get('folder')?.value"
            formControlName="folder" (keydown.enter)="saveSnippetSelected()" (change)="saveSnippetSelected()">

        <datalist id="folder_datalist">
            <option *ngFor="let path of albums$ | async" [value]="path">
                {{ path }}
            </option>
        </datalist>

        <button class="btn btn-sm " (click)="form.get('folder')?.setValue(''); saveSnippetSelected();">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>



    <!-- Simple offcanvas-like selector (no dependency on bootstrap JS) rendered from template for readability -->
    <ng-template #imageSelector>
        <div class="image-selector-backdrop" (click)="closeImageSelector()"></div>
        <div class="image-selector-panel opened" role="dialog" aria-modal="true">
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <strong>Choisir une image</strong>
                <button class="btn btn-sm btn-outline-secondary" (click)="closeImageSelector()">Fermer</button>
            </div>
            <div class="p-2">
                <ng-template #renderNode let-node let-prefix="prefix">
                    <ul class="list-unstyled ms-1">
                        <li *ngFor="let key of nodeKeys(node)">
                            <ng-container *ngIf="isFolder(node, key); else fileEntry">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-link p-0"
                                        (click)="toggleExpanded((prefix? prefix + '/' : '') + key); $event.stopPropagation()">
                                        <i
                                            [class]="isExpanded((prefix? prefix + '/' : '') + key) ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'"></i>
                                    </button>
                                    <span class="fw-bold">{{ key }}</span>
                                </div>
                                <div *ngIf="isExpanded((prefix? prefix + '/' : '') + key)" class="ms-3">
                                    <ng-container *ngIf="node[key]">
                                        <ng-container
                                            *ngTemplateOutlet="renderNode; context:{ $implicit: node[key], prefix: (prefix? prefix + '/' : '') + key }"></ng-container>
                                    </ng-container>
                                </div>
                            </ng-container>
                            <ng-template #fileEntry>
                                <div class="image-thumb d-flex align-items-center gap-2"
                                    (click)="selectImage(node[key].__data.path)">
                                    <img [src]="(getItemByPath((prefix? prefix + '/' : '') + key)?.url$ | async)" alt=""
                                        class="img-thumbnail" style="width:80px; height:60px; object-fit:cover;">
                                    <div class="small text-truncate" style="max-width:120px">{{ key }}</div>
                                </div>
                            </ng-template>
                        </li>
                    </ul>
                </ng-template>

                <div *ngIf="fileSystemNodeImages">
                    <ng-container
                        *ngTemplateOutlet="renderNode; context:{ $implicit: fileSystemNodeImages, prefix: '' }"></ng-container>
                </div>
            </div>
        </div>
    </ng-template>
</form>