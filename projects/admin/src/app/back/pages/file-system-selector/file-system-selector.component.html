<div class="file-system-selector-embed">
  <div class="mb-2 d-flex align-items-center gap-2">
    @if (allowCreateFolder) {
      <button type="button" class="btn btn-sm btn-outline-success" (click)="showCreateFolder = !showCreateFolder">Nouveau dossier</button>
    }
  </div>
  <div>
    @if (currentPath) {
      <div class="mb-2 small text-primary">
        <i class="bi bi-folder-fill me-1"></i>Dossier courant : <span class="fw-bold">{{ currentPath }}</span>
      </div>
    }
    @if (showCreateFolder && allowCreateFolder) {
      <div class="mb-2">
        <div class="input-group input-group-sm">
          <input type="text" class="form-control form-control-sm" placeholder="Nom du dossier" [(ngModel)]="newFolderName">
          <button type="button" class="btn btn-sm btn-primary" (click)="createFolder()">Créer</button>
        </div>
      </div>
    }
    <ng-template #renderNode let-node let-prefix="prefix">
      <ul class="list-unstyled ms-1">
        @for (key of nodeKeys(node); track key) {
          <li>
          @if (isFolder(node, key)) {
            <div class="d-flex align-items-center gap-2 current-folder-line"
              [class.current-folder-highlight]="currentPath === (prefix? prefix + '/' : '') + key">
              <button type="button" class="btn btn-sm btn-link p-0"
                (click)="toggleExpanded((prefix? prefix + '/' : '') + key); $event.stopPropagation()">
                <i [class]="isExpanded((prefix? prefix + '/' : '') + key) ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'"></i>
              </button>
              <span class="fw-bold"
                    (click)="selectOnFolderClick && onSelect((prefix? prefix + '/' : '') + key); $event.stopPropagation()"
                    [class.text-primary]="currentPath === (prefix? prefix + '/' : '') + key"
                    [class.text-muted]="currentPath !== (prefix? prefix + '/' : '') + key">
                {{ key }}
              </span>
                @if (allowActions) {
                  <button type="button" class="btn btn-sm btn-link text-success ms-2 position-relative" (click)="downloadFolderZip((prefix? prefix + '/' : '') + key); $event.stopPropagation()" title="Télécharger tout le dossier en zip" [disabled]="downloadingZipFolder === (prefix? prefix + '/' : '') + key">
                    <i class="bi bi-file-zip-fill"></i>
                    <span *ngIf="downloadingZipFolder === (prefix? prefix + '/' : '') + key" class="position-absolute top-50 start-50 translate-middle">
                      <span class="spinner-border spinner-border-sm text-secondary" style="z-index:2;"></span>
                    </span>
                  </button>
                  @if (prefix) {
                    <button type="button" class="btn btn-sm btn-link text-danger ms-2" (click)="deleteFolder((prefix? prefix + '/' : '') + key); $event.stopPropagation()" title="Supprimer le dossier et son contenu">
                      <i class="bi bi-folder-x"></i>
                    </button>
                  }
                }
              <button *ngIf="mode!=='files' && !selectOnFolderClick" type="button" class="btn btn-sm btn-link p-0 text-success ms-2" (click)="onSelect((prefix? prefix + '/' : '') + key); $event.stopPropagation()" title="Sélectionner le dossier">
                <i class="bi bi-folder-check"></i>
              </button>
            </div>
            @if (isExpanded((prefix? prefix + '/' : '') + key)) {
              <div class="ms-3">
                @if (node[key]) {
                  <ng-container *ngTemplateOutlet="renderNode; context:{ $implicit: node[key], prefix: (prefix? prefix + '/' : '') + key }"></ng-container>
                }
              </div>
            }
          } @else {
            @let url = getItemByPath((prefix? prefix + '/' : '') + key)?.url$ | async;
              <div class="image-thumb d-flex align-items-center gap-2" (click)="mode!=='folders' && selectPath(node[key].__data.path)">
              @if (rootFolder === 'documents/' || rootFolder === 'documents') {
                <i class="bi bi-file-earmark-fill" style="font-size:2rem;color:#888;"></i>
              } @else {
                @if (url) {
                  <img [src]="url" alt="" class="img-thumbnail" style="width:80px; height:60px; object-fit:cover;">
                }
              }
              <div class="small text-truncate" style="max-width:320px">{{ key.split('/').pop() }}</div>
                @if (allowActions) {
                  <button type="button" class="btn btn-sm btn-link text-danger ms-2" (click)="deleteFile(node[key].__data.path); $event.stopPropagation()" title="Supprimer">
                    <i class="bi bi-trash"></i>
                  </button>
                }
            </div>
          }
        </li>
        }
      </ul>
    </ng-template>

    @if (tree) {
      <ng-container *ngTemplateOutlet="renderNode; context:{ $implicit: tree, prefix: '' }"></ng-container>
    }
  </div>
</div>
