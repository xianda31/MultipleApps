<div class="file-browser">
  <!-- Selection Mode Header -->
  <div *ngIf="isSelectionMode" class="alert alert-info mb-2">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <small><i class="bi bi-cursor-fill"></i> <strong>Mode sélection:</strong> {{ selectionContext }}</small><br>
        <small class="text-muted">Cliquez sur un fichier ci-dessous puis sur "Sélectionner ce fichier"</small>
      </div>
      <button class="btn btn-sm btn-outline-secondary" (click)="cancelSelection()">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- Root Folder Selection (disabled in selection mode) -->
  <div class="root-selector mb-3" *ngIf="!isSelectionMode">
    <div class="btn-group w-100" role="group">
      <input type="radio" class="btn-check" name="rootFolder" id="root-images"
        value="images" [checked]="getCleanRoot() === 'images'" (change)="onRootChange('images')">
      <label class="btn btn-outline-primary btn-sm" for="root-images" [class.active]="getCleanRoot() === 'images'">Images</label>
      
      <input type="radio" class="btn-check" name="rootFolder" id="root-docs"
        value="documents" [checked]="getCleanRoot() === 'documents'" (change)="onRootChange('documents')">
      <label class="btn btn-outline-primary btn-sm" for="root-docs" [class.active]="getCleanRoot() === 'documents'">Documents</label>
      
      <input type="radio" class="btn-check" name="rootFolder" id="root-albums"
        value="albums" [checked]="getCleanRoot() === 'albums'" (change)="onRootChange('albums')">
      <label class="btn btn-outline-primary btn-sm" for="root-albums" [class.active]="getCleanRoot() === 'albums'">Albums</label>
    </div>
  </div>
  
  <!-- Selection Mode Root Display -->
  <div class="mb-3" *ngIf="isSelectionMode">
    <div class="alert alert-secondary mb-0 py-2">
      <small class="text-muted">
        <i class="bi bi-lock"></i> Mode automatique : 
        <strong>{{ getRootDisplayName(getCleanRoot()) }}</strong>
      </small>
    </div>
  </div>

  <!-- Current Path Display -->
  <div class="current-path mb-2">
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <i class="bi bi-folder"></i> {{ currentRoot }}/{{ currentPath || '(racine)' }}
      </small>
      <!-- CRUD buttons: hidden in selection mode -->
      <div class="btn-group btn-group-sm" *ngIf="!isSelectionMode">
        <!-- Create folder: only available when in a folder (root or subfolder) -->
        <button class="btn btn-outline-success btn-sm" 
                *ngIf="!currentPath || isCurrentPathAFolder()"
                (click)="showCreateFolder = !showCreateFolder" 
                title="Créer un dossier">
          <i class="bi bi-folder-plus"></i>
        </button>
        <!-- Delete folder: only if we have a path and it's a folder -->
        <button class="btn btn-outline-danger btn-sm" 
                *ngIf="currentPath && isCurrentPathAFolder()" 
                (click)="deleteCurrentFolder()" 
                title="Supprimer ce dossier">
          <i class="bi bi-trash"></i>
        </button>
        <!-- Delete file: only if we have a path and it's a file -->
        <button class="btn btn-outline-danger btn-sm" 
                *ngIf="currentPath && !isCurrentPathAFolder()" 
                (click)="deleteCurrentFile()" 
                title="Supprimer ce fichier">
          <i class="bi bi-file-x"></i>
        </button>
      </div>
      <!-- Selection mode indicator -->
      <div *ngIf="isSelectionMode" class="text-muted small">
        <i class="bi bi-cursor-fill"></i> Mode sélection
      </div>
    </div>
    
    <!-- Create folder form -->
    <div class="mt-2" *ngIf="showCreateFolder">
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" 
               placeholder="Nom du dossier" 
               [(ngModel)]="newFolderName" 
               (keyup.enter)="createFolder()">
        <button class="btn btn-success" type="button" (click)="createFolder()">
          <i class="bi bi-check"></i>
        </button>
        <button class="btn btn-secondary" type="button" (click)="showCreateFolder = false; newFolderName = ''">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Apply Selection Buttons (compact layout) -->
  <div *ngIf="isSelectionMode && currentPath" class="mb-3 p-2 bg-light rounded border">
    <div class="small text-muted mb-2">
      <i class="bi bi-check-circle"></i> Fichier sélectionné: 
      <strong>{{ getNameFromPath(currentPath) }}</strong>
    </div>
    
    <div class="d-flex align-items-center gap-2">
      <!-- Image preview if it's an image -->
      <div *ngIf="selectionType === 'image' && currentPath && isImageFile(currentPath)" class="flex-shrink-0">
        <img [src]="getImagePreviewUrl(currentPath)" 
             class="img-thumbnail" 
             style="max-height: 60px; max-width: 80px;"
             [alt]="getNameFromPath(currentPath)">
      </div>
      
      <!-- Action buttons -->
      <div class="flex-grow-1 d-flex flex-column gap-1">
        <button class="btn btn-success btn-sm" (click)="applySelection()">
          <i class="bi bi-check-circle"></i> Sélectionner ce fichier
        </button>
        <button class="btn btn-outline-secondary btn-sm" (click)="cancelSelection()">
          <i class="bi bi-x-circle"></i> Annuler la sélection
        </button>
      </div>
    </div>
  </div>

  <!-- File Tree -->
  <div class="file-tree" [class.selection-mode]="isSelectionMode" style="max-height: 70vh; overflow-y: auto;">
    <ng-container *ngTemplateOutlet="renderNode; context: { $implicit: fileTree, prefix: '' }"></ng-container>
  </div>
</div>

<!-- File Tree Recursive Template -->
<ng-template #renderNode let-node let-prefix="prefix">
  <div *ngFor="let key of getObjectKeys(node)" class="file-node">
    <!-- File Item -->
    <div *ngIf="isLeafNode(node[getOriginalKey(node, key)])" 
         class="file-item d-flex align-items-center py-1 px-2 hover-bg"
         [class.selected]="(prefix ? prefix + '/' + key : key) === currentPath"
         (click)="onPathSelect(prefix ? prefix + '/' + key : key)">
      <i class="{{ getFileIcon(key) }} me-2"></i>
      <span class="file-name">{{ key }}</span>
    </div>
    
    <!-- Folder Item -->
    <div *ngIf="!isLeafNode(node[getOriginalKey(node, key)])" class="folder-item">
      <div class="folder-header d-flex align-items-center py-1 px-2 hover-bg"
           [class.selected]="(prefix ? prefix + '/' + key : key) === currentPath">
        <!-- Chevron for expand/collapse -->
        <i class="chevron me-1" 
           [class]="isFolderExpanded(prefix ? prefix + '/' + key : key) ? 'bi bi-chevron-down' : 'bi bi-chevron-right'"
           (click)="toggleFolderExpansion(prefix ? prefix + '/' + key : key)"></i>
        <!-- Folder icon and name -->
        <i class="bi bi-folder-fill me-2 text-warning"></i>
        <span class="folder-name fw-medium" 
              (click)="onPathSelect(prefix ? prefix + '/' + key : key); toggleFolderExpansion(prefix ? prefix + '/' + key : key)">{{ key }}</span>
      </div>
      <!-- Collapsible folder contents -->
      <div class="folder-children ps-3" *ngIf="isFolderExpanded(prefix ? prefix + '/' + key : key)">
        <ng-container *ngTemplateOutlet="renderNode; context: { $implicit: node[getOriginalKey(node, key)], prefix: (prefix ? prefix + '/' : '') + key }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>