<div *ngIf="loaded" class="card mt-2">

  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5>Ecritures comptables
      </h5>

      <div class="d-flex align-items-center">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault"
            (change)="toggle_slice()" [checked]="slice_start < 0">
          <label class="form-check-label" for="switchCheckDefault">{{(slice_start<0)? -slice_start + ' dernières'
              : 'toutes' }}</label>
        </div>
        <div class="ms-3 text-primary" style="cursor: pointer;" (click)="backward_slice()">
          <i class="bi bi-skip-backward-fill"></i>
        </div>
      </div>

      <div *ngIf="!isMobilePortrait">
        export excel :
        <button class="btn btn-sm btn-primary" (click)="exportExcel()">
          <i class="bi bi-filetype-xls"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="card-body">
    <div class="d-flex text-mute mb-2">
      <span class="text-muted">reset tri :&nbsp; </span>
      <span *ngFor="let criteria of criterias" class="text-muted me-2">{{criteria}} </span>
      <span class="text-muted">
        <i class="bi bi-arrow-counterclockwise" (click)="sort_clear()"></i>
      </span>
    </div>
    <table class="table table-responsive table-sm table-striped table-hover">
      <thead>
        <tr>
          <th class="col th_hover" (click)="sort_by('date')">date </th>
          <th class="col">libellé</th>
          <th class="col">produits/charges</th>
          <th class="col" (click)="sort_by('montant')" style="cursor: pointer;"> montant</th>
          <th class="col"> doc.</th>
          <th class="col" (click)="sort_by('tag')" style="cursor: pointer;"> commentaire </th>
          <th class="col" (click)="sort_by('classe')" style="cursor: pointer;">classe </th>
          <th class="col" (click)="sort_by('transaction')" style="cursor: pointer;"> type</th>
          <th class="col text-center">actions</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let entry of book_entries | slice : slice_start, let i = index ">
          <tr *ngFor="let operation of entry.operations, , let first=first">
            <td *ngIf="first" (click)="show_book_entry(entry.id)" [rowSpan]="entry.operations.length"> {{entry.date |
              date: 'dd/MM'}} </td>
            <td>{{operation.member ? operation.member : operation.label}}</td>
            <td>{{operation.values | json}}</td>
            <td *ngIf="first" [rowSpan]="entry.operations.length" class="text-end pe-3"> {{total_amount(entry) |
              number:truncature:'fr'}}
            </td>
            <td *ngIf="first" [rowSpan]="entry.operations.length">
              <ng-container *ngIf="invoice_required(entry)" >
                <ng-container *ngIf="entry.invoice_ref; else uploadIcon">
                  <span class="me-3 align-middle d-inline-flex align-items-center" style="cursor:pointer" (click)="download_invoice_pdf(entry.invoice_ref)">
                    <i class="bi-file-earmark-arrow-down-fill text-info fs-5"></i>
                    <span class="ms-1">consulter</span>
                  </span>
                </ng-container>
                <ng-template #uploadIcon>
                  <span class="me-3 align-middle d-inline-flex align-items-center" style="cursor:pointer" (click)="add_invoice_ref(entry)">
                    <i class="bi bi-file-earmark-plus-fill text-success fs-5"></i>
                    <span class="ms-1">ajouter</span>
                  </span>
                </ng-template>
              </ng-container>
              <span class="align-middle">{{entry.invoice_ref}}</span>
            </td>
            <td *ngIf="first" [rowSpan]="entry.operations.length"> {{entry.tag}} </td>
            <td *ngIf="first" [rowSpan]="entry.operations.length"> {{class_label(entry) }} </td>
            <td *ngIf="first" [rowSpan]="entry.operations.length">{{transaction_label(entry)}}</td>
            <td *ngIf="first" [rowSpan]="entry.operations.length">
              <div class="d-flex justify-content-lg-around">
                <button class="btn btn-sm btn-outline-primary" (click)="show_book_entry(entry.id)">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" (click)="delete_book_entry(entry)">
                  <i class="bi bi-trash3"></i>
                </button>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>

    </table>
  </div>

</div>

<ng-template #slice_toggler>

</ng-template>