<div class="container menus-editor-root">


    <div class="form-check form-switch sandbox-switch">
        <input class="form-check-input" type="checkbox" id="sandboxSwitch" [checked]="sandboxService.value"
            (change)="setSandbox($event.target.checked)">
        <label class="form-check-label" for="sandboxSwitch">
            Mode Sandbox <span class="state" [class.on]="sandboxService.value">({{ sandboxService.value ?
                'ON' : 'OFF' }})</span>
        </label>
        <!-- Bouton masqué temporairement jusqu'à décision sur la stratégie de promotion -->
        <button class="btn btn-sm btn-warning ms-3 d-none" (click)="promoteSandboxMenus()"
            [disabled]="!sandboxService.value">
            Promouvoir vers production
        </button>
    </div>

    <div class="col-12 mt-3">
        <h6>Simulateur barre de navigation</h6>
        <div class="">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="previewLoggedSwitch" [(ngModel)]="previewLogged">
                <label class="form-check-label" for="previewLoggedSwitch">
                    Utilisateur connecté (prévisualisation)
                </label>
            </div>
        </div>
        <ng-container *ngTemplateOutlet="navbar_simulation"></ng-container>
    </div>

    <div class="col-12 mt-3">
        <h6>Tableau des menus</h6>
        <ng-container *ngTemplateOutlet="menu_table"></ng-container>
        <!-- <ng-container *ngTemplateOutlet="show_routes"></ng-container> -->
    </div>

    <div class="col-12 mt-3">
        <h6>Routes front-end</h6>
        <ng-container *ngTemplateOutlet="show_routes"></ng-container>
    </div>
    <!-- </div> -->
</div>

<ng-template #show_routes>
    @if(front_routes && front_routes[0].children) {

    @for (route of front_routes[0].children; track route.path) {
    <div>
        <strong>Path:</strong> {{ route.path }}
        @if (route.component) {<strong>:</strong> {{ route.component.name }} }
        @if (route.data) {<strong>:</strong> {{ route.data | json }} }

    </div>
    }
    }
</ng-template>
<ng-template #navbar_simulation>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">MonSite</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            </button>
            <span class="navbar-toggler-icon"></span>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul #navDropList="cdkDropList" class="navbar-nav nav-drop-list mb-2 mb-lg-0" cdkDropList [cdkDropListData]="visibleNavbarEntries"
                    cdkDropListOrientation="horizontal"
                    (cdkDropListDropped)="onParentDrop($event)">
                    @for (menu of visibleNavbarEntries; track menu.navitem.id) {
                        <ng-container *ngIf="menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0; else simpleItem">
                            <li class="nav-item dropdown ms-3 d-flex align-items-center" ngbDropdown
                                cdkDrag [cdkDragData]="menu" [cdkDragDisabled]="false" cdkDragBoundary="#navbarNav"
                                [attr.data-nav-id]="menu.navitem.id"
                                (cdkDragStarted)="onDragStarted($event)" (cdkDragMoved)="onDragMoved($event)" (cdkDragEnded)="onDragEnded($event)">
                            <ng-template cdkDragPreview>
                                <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                    <span class="drag-handle me-1"><i class="bi bi-grip-vertical text-muted"></i></span>
                                    <span class="drag-label">{{ label_transformer_simulation(menu.navitem) }}</span>
                                </div>
                            </ng-template>
                            <span class="drag-handle me-1" cdkDragHandle><i class="bi bi-grip-vertical text-muted"></i></span>
                            <a class="nav-link dropdown-toggle" ngbDropdownToggle id="nav-{{ menu.navitem.id }}">
                                @if(menu.navitem.pre_label === 'avatar') {
                                <span class="rounded-circle d-inline-flex justify-content-center align-items-center bg-secondary text-white me-1"
                                    style="width:28px; height:28px; max-width:28px; max-height:28px; font-size:0.75rem; line-height:28px;">JD</span>
                                }
                                {{ label_transformer_simulation(menu.navitem) }}
                            </a>
                            <ul class="dropdown-menu" ngbDropdownMenu [attr.aria-labelledby]="'nav-' + menu.navitem.id"
                                cdkDropList [cdkDropListData]="menu.childs"
                                cdkDropListOrientation="vertical"
                                [attr.data-parent-id]="menu.navitem.id"
                                [cdkDropListEnterPredicate]="childEnterPredicate"
                                (cdkDropListDropped)="onChildDrop($event, menu)">
                                @for (child of (menu.childs || []); track child.navitem.id) {
                                    @if ((child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
                                    || (child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY && previewLogged)
                                    || (child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY && !previewLogged)) {
                                        <li class="nav-item ms-3 d-flex align-items-center" cdkDrag [cdkDragData]="child" [cdkDragDisabled]="false"
                                            [attr.data-nav-id]="child.navitem.id"
                                            (cdkDragStarted)="onDragStarted($event)" (cdkDragMoved)="onDragMoved($event)" (cdkDragEnded)="onDragEnded($event)">
                                            <ng-template cdkDragPreview>
                                                <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                                    <span class="drag-handle me-1"><i class="bi bi-grip-vertical text-muted"></i></span>
                                                    <span class="drag-label">{{ label_transformer_simulation(child.navitem) }}</span>
                                                </div>
                                            </ng-template>
                                            <span class="drag-handle me-1" cdkDragHandle><i class="bi bi-grip-vertical text-muted"></i></span>
                                            <button class="nav-link btn btn-link p-0" type="button" (click)="show_page(child.navitem)">
                                                <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: child }"></ng-container>
                                            </button>
                                        </li>
                                    }
                                }
                            </ul>
                            </li>
                        </ng-container>
                        <ng-template #simpleItem>
                            <li class="nav-item ms-3 d-flex align-items-center" cdkDrag [cdkDragData]="menu" [cdkDragDisabled]="false" cdkDragBoundary="#navbarNav"
                                [attr.data-nav-id]="menu.navitem.id"
                                (cdkDragStarted)="onDragStarted($event)" (cdkDragMoved)="onDragMoved($event)" (cdkDragEnded)="onDragEnded($event)">
                                <ng-template cdkDragPreview>
                                    <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                        <span class="drag-handle me-1"><i class="bi bi-grip-vertical text-muted"></i></span>
                                        <span class="drag-label">{{ label_transformer_simulation(menu.navitem) }}</span>
                                    </div>
                                </ng-template>
                                <span class="drag-handle me-1" cdkDragHandle><i class="bi bi-grip-vertical text-muted"></i></span>
                                <button class="nav-link btn btn-link p-0" type="button" (click)="show_page(menu.navitem)">
                                    <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
                                </button>
                            </li>
                        </ng-template>
                    }
                </ul>
            </div>
            

        </div>
    </nav>


    <!-- Recursive template removed: rendering limited to two levels (top + submenu) -->

    <ng-template #menuLabelTemplate let-menu>
        @if(menu.navitem.pre_label === 'avatar') {
        <span class="rounded-circle d-inline-flex justify-content-center align-items-center bg-secondary text-white me-1"
            style="width:28px; height:28px; max-width:28px; max-height:28px; font-size:0.75rem; line-height:28px;">JD</span>
        }
        {{ label_transformer_simulation(menu.navitem) }}
    </ng-template>
</ng-template>


<ng-template #router_preview>
    <div class="alert alert-secondary" role="alert">
        {{ front_route_verbose }}

        @if (selected_page) {
        <h5>Page sélectionnée :</h5>
        <p><strong>Titre :</strong> {{ selected_page.title }}</p>
        <p><strong>Contenu :</strong></p>
        <!-- <div [innerHTML]="stringToSafeHtml(selected_page.content)"></div> -->
        }
    </div>
</ng-template>

<ng-template #menu_table>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Libellé</th>
                    <th>Type</th>
                    <th>Param.</th>
                    <th>Path</th>
                    <th>Rank</th>
                    <th>Visibilité</th>
                    <th>Préfixe label</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (entry of menus; let i = $index; track entry.navitem.id) {
                <ng-container
                    *ngTemplateOutlet="menuTableRecursive; context: { $implicit: entry, parentIndex: (i + 1), indent: 0 }"></ng-container>
                }
                <!-- Template récursive pour la table des menus -->
                <ng-template #menuTableRecursive let-entry let-parentIndex="parentIndex" let-indent="indent">
                    <tr>
                        <td>{{ parentIndex }}</td>
                        <td [style.padding-left.px]="indent * 24"><strong>{{ entry.navitem.label }}</strong></td>
                        <td>{{ entry.navitem.type }}</td>
                        <td>{{ entry.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE ? entry.navitem.page_title :
                            (entry.navitem.type === NAVITEM_TYPE.PLUGIN ? entry.navitem.plugin_name :
                            (entry.navitem.type === NAVITEM_TYPE.DIRECT_CALL ? entry.navitem.slug : '')) }}</td>
                        <td>{{ entry.navitem.path }}</td>
                        <td>{{ entry.navitem.rank }}</td>
                        <td>{{ entry.navitem.logging_criteria }}</td>
                        <td>{{ entry.navitem.pre_label }}</td>
                        <td><i (click)="editNavitem(entry.navitem)" class="bi bi-pencil-square" role="button"
                                title="Éditer"></i></td>
                    </tr>
                    @for (childGroup of entry.childs; let j = $index; track childGroup.navitem.id) {
                    <ng-container
                        *ngTemplateOutlet="menuTableRecursive; context: { $implicit: childGroup, parentIndex: parentIndex + '.' + (j + 1), indent: indent + 1 }"></ng-container>
                    }
                </ng-template>
            </tbody>
            <tbody>
                <tr>
                    <td colspan="8" class="text-end">
                        <button class="btn btn-sm btn-outline-primary" (click)="createNavItem()">
                            <i class="bi bi-plus-square-fill"></i> Ajouter un élément
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</ng-template>

<ng-template #editNavitemOffcanvas let-offcanvas>
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Édition élément de menu</h5>
        <button type="button" class="btn-close text-reset" aria-label="Close" (click)="offcanvas.dismiss()"></button>
    </div>
    <div class="offcanvas-body">
        <form [formGroup]="navItemForm" class="vstack gap-3">
            <div class="row g-2">
                <div class="col-12">
                    <label class="form-label">Position</label>
                    <select class="form-select" formControlName="position">
                        @for (pos of NAVITEM_POSITIONS; track pos) {<option [ngValue]="pos">{{ pos }}</option>}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="previewLoggedSwitch"
                                [(ngModel)]="previewLogged" [ngModelOptions]="{standalone:true}"
                                (change)="onPreviewToggle($event.target.checked)">
                        </div>
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label">Libellé</label>
                    <div class="input-group">
                        <select class="form-select" [ngModel]="currentLabelToken"
                            (ngModelChange)="useSpecialLabel($event)" [ngModelOptions]="{standalone:true}">
                            <option [ngValue]="''">— libellé libre —</option>
                            @for (tok of SPECIAL_LABELS; track tok) {<option [ngValue]="tok">{{ tok }}</option>}
                        </select>
                        <input type="text" class="form-control" formControlName="label" placeholder="Texte du menu" />
                    </div>
                    <div class="form-text">Le champ est éditable uniquement avec "libellé libre".</div>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label">Type</label>
                        <select class="form-select" formControlName="type">
                            @for (t of NAVITEM_TYPES; track t) {<option [ngValue]="t">{{ t }}</option>}
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Parent (Dropdown)</label>
                        <select class="form-select" formControlName="parent_id">
                            <option [ngValue]="null">Aucun</option>
                            @for (n of navitems; track n.id) {
                            <option [ngValue]="n.id" [hidden]="n.type !== NAVITEM_TYPE.DROPDOWN">{{ n.path }}
                            </option>
                            }
                        </select>
                    </div>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label">Visibilité</label>
                        <select class="form-select" formControlName="logging_criteria">
                            @for (crit of NAVITEM_LOGGING_CRITERIA_VALUES; track crit) {
                            <option [ngValue]="crit">{{ crit }}</option>
                            }
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Préfixe label</label>
                        <select class="form-select" formControlName="pre_label">
                            @for (pre of ['icon', 'avatar', null]; track pre) {
                            <option [ngValue]="pre">{{ pre }}</option>
                            }
                        </select>
                    </div>
                </div>

                @if (navItemForm.get('type')?.value === NAVITEM_TYPE.DIRECT_CALL) {
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Commande</label>
                        <select class="form-select" formControlName="command_name">
                            @for (c of NAVITEM_COMMANDS; track c) {<option [ngValue]="c">{{ c }}</option>}
                        </select>
                        <div class="form-text">Action exécutée au clic (sans navigation).</div>
                    </div>
                </div>
                } @else {
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label">Segment (slug)</label>
                        <input type="text" class="form-control" formControlName="slug" placeholder="ex: club"
                            [class.is-invalid]="navItemForm.get('type')?.value !== NAVITEM_TYPE.DROPDOWN && navItemForm.get('slug')?.invalid && (navItemForm.get('slug')?.dirty || navItemForm.get('slug')?.touched)" />
                        <div class="invalid-feedback">
                            Seuls les caractères minuscules, chiffres et '_' sont autorisés.
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Path (auto)</label>
                        <input type="text" class="form-control" formControlName="path" readonly />
                        <div class="form-text">Concatène le parent et le segment.</div>
                    </div>
                </div>
                }

                @if (navItemForm.get('type')?.value === NAVITEM_TYPE.PLUGIN && navItemForm.get('plugin_name')?.value ===
                NAVITEM_PLUGIN.IFRAME) {
                <div class="col-12">
                    <label class="form-label">URL externe</label>
                    <input type="url" class="form-control" formControlName="external_url" placeholder="https://..." />
                </div>
                }
                @if (navItemForm.get('type')?.value === NAVITEM_TYPE.EXTERNAL_REDIRECT && selectedNavitem) {
                <div class="col-12">
                    <label class="form-label">URL externe à ouvrir</label>
                    <input id="externalUrlInput" type="url" class="form-control" formControlName="external_url"
                        placeholder="https://...">
                </div>
                }

                @if (navItemForm.get('type')?.value === NAVITEM_TYPE.PLUGIN) {
                <div class="col-12">
                    <label class="form-label">Plug-in</label>
                    <select class="form-select" formControlName="plugin_name">
                        @for (p of NAVITEM_PLUGINS; track p) {<option [ngValue]="p">{{ p }}</option>}
                    </select>
                </div>
                }

                @if (navItemForm.get('type')?.value === NAVITEM_TYPE.CUSTOM_PAGE) {
                <div class="col-12">
                    <label class="form-label">Page</label>
                    <select class="form-select" formControlName="page_id">
                        @for (pg of pages; track pg.id) {<option [ngValue]="pg.id">{{ pg.title }}</option>}
                    </select>
                </div>
                }

                <div class="d-flex gap-2 justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-secondary"
                        (click)="offcanvas.dismiss()">Annuler</button>
                    @if(selectedNavitem?.id){
                    <button type="button" class="btn btn-danger"
                        (click)="deleteNavitem(selectedNavitem!)">Supprimer</button>
                    }
                    <button type="button" class="btn btn-primary" (click)="saveNavitem()"
                        [disabled]="navItemForm.invalid">Enregistrer</button>
                </div>
            </div>
        </form>
    </div>
</ng-template>