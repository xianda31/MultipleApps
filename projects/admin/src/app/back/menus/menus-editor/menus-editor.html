<div class="container-fluid menus-editor-root mt-2">
    <h5 class="mb-3 text-center">Éditeur des menus</h5>

    <div class="row">
        <!-- Column 0: Configuration BD -->
        <div class="col-12 col-lg-2">
            <div class="card border-0 mb-1">
                <div class="card-header" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                    <h6 class="mb-0">Base de données</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="card text-center" style="min-width: 120px;">
                            <div class="card-header bg-success text-white py-1">
                                <strong>Sandbox</strong>
                            </div>
                            <div class="card-body py-2">
                                <h5 class="mb-0">{{ sandboxCount }}</h5>
                                <small class="text-muted">navitem(s)</small>
                            </div>
                        </div>

                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-sm btn-outline-primary" (click)="cloneProductionToSandbox()"
                                [disabled]="sandboxService.value || isProcessing"
                                title="Copie tous les menus de production vers sandbox pour édition">
                                @if (isProcessing) {
                                <span class="spinner-border spinner-border-sm me-1" role="status"
                                    aria-hidden="true"></span>
                                } @else {
                                <i class="bi bi-arrow-left"></i>
                                }
                            </button>
                            <button class="btn btn-sm btn-warning" (click)="promoteSandboxToProduction()"
                                [disabled]="!hasSandboxNavitems || isProcessing"
                                title="Remplace tous les menus de production par les menus sandbox validés">
                                @if (isProcessing) {
                                <span class="spinner-border spinner-border-sm me-1" role="status"
                                    aria-hidden="true"></span>
                                } @else {
                                <i class="bi bi-arrow-right"></i>
                                }
                            </button>
                            @if (hasSandboxNavitems) {
                            <button class="btn btn-sm btn-outline-danger" (click)="deleteSandbox()"
                                [disabled]="isProcessing"
                                title="Supprimer tous les menus sandbox (abandon du travail en cours)">
                                @if (isProcessing) {
                                <span class="spinner-border spinner-border-sm me-1" role="status"
                                    aria-hidden="true"></span>
                                } @else {
                                <i class="bi bi-trash"></i>
                                }
                            </button>
                            }
                        </div>

                        <div class="card text-center" style="min-width: 120px;">
                            <div class="card-header bg-warning text-dark py-1">
                                <strong>Production</strong>
                            </div>
                            <div class="card-body py-2">
                                <h5 class="mb-0">{{ productionCount }}</h5>
                                <small class="text-muted">navitem(s)</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check form-switch sandbox-switch">
                        <input class="form-check-input" type="checkbox" id="sandboxSwitch"
                            [checked]="sandboxService.value" [disabled]="!hasSandboxNavitems"
                            (change)="setSandbox($event.target.checked)">
                        <label class="form-check-label" for="sandboxSwitch">
                            Visualisation menu <span class="state" [class.on]="sandboxService.value">{{
                                sandboxService.value ?
                                'Sandbox' : 'Production' }}</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 1: Editeur menus + Simulations -->
        <div class="col-12 col-lg-6">
            @if (!hasSandboxNavitems) {
            <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Sandbox vide :</strong> L'édition des menus n'est pas possible tant que la sandbox est vide. 
                Utilisez le bouton de copie pour initialiser la sandbox avec les menus de production.
            </div>
            } @else {
            <div class="card border-0 mb-1">
                <div class="card-header d-flex align-items-center justify-content-between"
                    style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                    <h6 class="mb-0">Barres de menu</h6>
                    <div class="form-check form-switch mb-0" style="min-height: 0; padding: 0;">
                        <input class="form-check-input" type="checkbox" id="previewLoggedSwitch"
                            [(ngModel)]="previewLogged" (change)="onPreviewToggle(previewLogged)"
                            style="margin-top: 0;">
                        <label class="form-check-label" for="previewLoggedSwitch"
                            style="line-height: 1; padding-left: 0.25rem;">
                            <small>Mode utilisateur connecté</small>
                        </label>
                    </div>
                </div>
                <div class="card-body">

                    <!-- Simulations navbar et footer -->
                    <ng-container *ngTemplateOutlet="navbar_simulation"></ng-container>
                    <ng-container *ngTemplateOutlet="footbar_simulation"></ng-container>
                </div>
            </div>
            }
        </div>
        <!-- Column 2: vide -->
        <div class="col-12 col-lg-4">
        </div>
    </div>


    <div class="row">
        <div class="col-12">
            <div class="form-check form-switch sandbox-switch">
                <input class="form-check-input" type="checkbox" id="debugInfoSwitch" [(ngModel)]="showDebugInfo">
                <label class="form-check-label" for="debugInfoSwitch">
                    Afficher les informations de débogage
                </label>
            </div>
        </div>
    </div>

    @if (showDebugInfo) {
    <div class="row">
        <div class="col-12">
            <div class="card border-0 mb-1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Informations de débogage</h6>
                    <span class="badge" [ngClass]="sandboxService.value ? 'bg-success' : 'bg-warning'">
                        Mode actif : {{ sandboxService.value ? 'SANDBOX' : 'PRODUCTION' }} ({{ navitems.length || 0 }} navitems)
                    </span>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note :</strong> Les informations ci-dessous affichent uniquement les navitems de la configuration <strong>{{ sandboxService.value ? 'SANDBOX' : 'PRODUCTION' }}</strong>.
                        Pour voir les navitems de l'autre configuration, basculez le switch "Visualisation menu" ci-dessus.
                    </div>
                    <div class="mt-3">
                        <h6>Tableau des menus</h6>
                        <ng-container *ngTemplateOutlet="menu_table"></ng-container>
                    </div>

                    <div class="mt-3">
                        <h6>Routes front-end</h6>
                        <ng-container *ngTemplateOutlet="show_routes"></ng-container>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
    <ng-template #show_routes>
        @if((sandboxService.value ? front_routes : front_routes_production) && (sandboxService.value ? front_routes : front_routes_production)[0].children) {

        @for (route of (sandboxService.value ? front_routes : front_routes_production)[0].children; track route.path) {
        <div>
            <strong>Path:</strong> {{ route.path }}
            @if (route.component) {<strong>:</strong> {{ route.component.name }} }
            @if (route.data) {<strong>:</strong> {{ route.data | json }} }

        </div>
        }
        }
    </ng-template>
    <ng-template #navbar_simulation>
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
            <div class="container-fluid">
                <!-- <h6 class="d-inline-block me-3">Barre de navigation</h6> -->
                @if (brandNavitem) {
                <span class="navbar-brand d-flex align-items-center" style="font-size: 1.25rem; font-weight: 600;">
                    {{ label_transformer_simulation(brandNavitem) }}
                    <i (click)="hasSandboxNavitems && editNavitem(brandNavitem); $event.stopPropagation()"
                        [class]="'bi bi-pencil-square ms-1 ' + (hasSandboxNavitems ? 'text-success' : 'text-muted')"
                        [style.cursor]="hasSandboxNavitems ? 'pointer' : 'not-allowed'"
                        [style.opacity]="hasSandboxNavitems ? '1' : '0.5'"
                        role="button" [title]="hasSandboxNavitems ? 'Éditer' : 'Sandbox vide - édition désactivée'"
                        style="font-size: 0.75rem;"></i>
                </span>
                <div class="border-end border-2 border-secondary mx-3" style="height: 30px;"></div>
                }
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul #navDropList="cdkDropList" class="navbar-nav nav-drop-list mb-2 mb-lg-0" cdkDropList
                        [cdkDropListData]="visibleNavbarEntries" cdkDropListOrientation="horizontal"
                        (cdkDropListDropped)="onParentDrop($event)">
                        @for (menu of visibleNavbarEntries; track menu.navitem.id) {
                        <ng-container
                            *ngIf="menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0; else simpleItem">
                            <li class="nav-item dropdown ms-1 d-flex align-items-center" ngbDropdown cdkDrag
                                [cdkDragData]="menu" [cdkDragDisabled]="false" cdkDragBoundary="#navbarNav"
                                [attr.data-nav-id]="menu.navitem.id" (cdkDragStarted)="onDragStarted($event)"
                                (cdkDragMoved)="onDragMoved()" (cdkDragEnded)="onDragEnded()">
                                <ng-template cdkDragPreview>
                                    <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                        <span class="drag-handle me-1"><i
                                                class="bi bi-grip-vertical text-muted"></i></span>
                                        <span class="drag-label">{{ label_transformer_simulation(menu.navitem) }}</span>
                                    </div>
                                </ng-template>
                                <span class="drag-handle me-1" cdkDragHandle><i
                                        class="bi bi-grip-vertical text-muted"></i></span>
                                <a class="nav-link dropdown-toggle" ngbDropdownToggle id="nav-{{ menu.navitem.id }}">
                                    @if(menu.navitem.pre_label === 'avatar') {
                                    <span
                                        class="rounded-circle d-inline-flex justify-content-center align-items-center bg-secondary text-white me-1"
                                        style="width:28px; height:28px; max-width:28px; max-height:28px; font-size:0.75rem; line-height:28px;">JD</span>
                                    }
                                    {{ label_transformer_simulation(menu.navitem) }}
                                    <i (click)="hasSandboxNavitems && editNavitem(menu.navitem); $event.stopPropagation()"
                                        [class]="'bi bi-pencil-square ms-1 ' + (hasSandboxNavitems ? 'text-success' : 'text-muted')"
                                        [style.cursor]="hasSandboxNavitems ? 'pointer' : 'not-allowed'"
                                        [style.opacity]="hasSandboxNavitems ? '1' : '0.5'"
                                        role="button" [title]="hasSandboxNavitems ? 'Éditer' : 'Sandbox vide - édition désactivée'"
                                        style="font-size: 0.75rem;"></i>
                                </a>
                                <ul class="dropdown-menu" ngbDropdownMenu
                                    [attr.aria-labelledby]="'nav-' + menu.navitem.id" cdkDropList
                                    [cdkDropListData]="menu.childs" cdkDropListOrientation="vertical"
                                    [attr.data-parent-id]="menu.navitem.id"
                                    [cdkDropListEnterPredicate]="childEnterPredicate"
                                    (cdkDropListDropped)="onChildDrop($event, menu)">
                                    @for (child of (menu.childs || []); track child.navitem.id) {
                                    @if ((child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
                                    || (child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY &&
                                    previewLogged)
                                    || (child.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY &&
                                    !previewLogged)) {
                                    <li class="nav-item ms-3 d-flex align-items-center" cdkDrag [cdkDragData]="child"
                                        [cdkDragDisabled]="false" [attr.data-nav-id]="child.navitem.id"
                                        (cdkDragStarted)="onDragStarted($event)" (cdkDragMoved)="onDragMoved()"
                                        (cdkDragEnded)="onDragEnded()">
                                        <ng-template cdkDragPreview>
                                            <div
                                                class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                                <span class="drag-handle me-1"><i
                                                        class="bi bi-grip-vertical text-muted"></i></span>
                                                <span class="drag-label">{{ label_transformer_simulation(child.navitem)
                                                    }}</span>
                                            </div>
                                        </ng-template>
                                        <span class="drag-handle me-1" cdkDragHandle><i
                                                class="bi bi-grip-vertical text-muted"></i></span>
                                        <button class="nav-link btn btn-link p-0" type="button"
                                            (click)="show_page(child.navitem)">
                                            <ng-container
                                                *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: child }"></ng-container>
                                        </button>
                                    </li>
                                    }
                                    }
                                </ul>
                            </li>
                        </ng-container>
                        <ng-template #simpleItem>
                            <li class="nav-item ms-1 d-flex align-items-center" cdkDrag [cdkDragData]="menu"
                                [cdkDragDisabled]="false" cdkDragBoundary="#navbarNav"
                                [attr.data-nav-id]="menu.navitem.id" (cdkDragStarted)="onDragStarted($event)"
                                (cdkDragMoved)="onDragMoved()" (cdkDragEnded)="onDragEnded()">
                                <ng-template cdkDragPreview>
                                    <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                        <span class="drag-handle me-1"><i
                                                class="bi bi-grip-vertical text-muted"></i></span>
                                        <span class="drag-label">{{ label_transformer_simulation(menu.navitem) }}</span>
                                    </div>
                                </ng-template>
                                <span class="drag-handle me-1" cdkDragHandle><i
                                        class="bi bi-grip-vertical text-muted"></i></span>
                                <button class="nav-link btn btn-link p-0" type="button"
                                    (click)="show_page(menu.navitem)">
                                    <ng-container
                                        *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
                                </button>
                            </li>
                        </ng-template>
                        }
                    </ul>
                </div>
                <button class="btn btn-sm btn-outline-success ms-1" (click)="createNavItem()"
                    [disabled]="!hasSandboxNavitems"
                    [title]="hasSandboxNavitems ? 'Créer un nouvel élément de menu' : 'Sandbox vide - création désactivée'">
                    <i class="bi bi-plus-square-fill"></i>
                </button>

            </div>
        </nav>


        <!-- Recursive template removed: rendering limited to two levels (top + submenu) -->

        <ng-template #menuLabelTemplate let-menu>
            @if(menu.navitem.pre_label === 'avatar') {
            <span
                class="rounded-circle d-inline-flex justify-content-center align-items-center bg-secondary text-white me-1"
                style="width:28px; height:28px; max-width:28px; max-height:28px; font-size:0.75rem; line-height:28px;">JD</span>
            }
            {{ label_transformer_simulation(menu.navitem) }}
            <i (click)="hasSandboxNavitems && editNavitem(menu.navitem); $event.stopPropagation()"
                [class]="'bi bi-pencil-square ms-1 ' + (hasSandboxNavitems ? 'text-success' : 'text-muted')"
                [style.cursor]="hasSandboxNavitems ? 'pointer' : 'not-allowed'"
                [style.opacity]="hasSandboxNavitems ? '1' : '0.5'"
                role="button" [title]="hasSandboxNavitems ? 'Éditer' : 'Sandbox vide - édition désactivée'"
                style="font-size: 0.75rem;"></i>
        </ng-template>
    </ng-template>

    <ng-template #footbar_simulation>
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="footbarNav">
                    <ul #footDropList="cdkDropList" class="navbar-nav nav-drop-list mb-2 mb-lg-0 mx-auto" cdkDropList
                        [cdkDropListData]="visibleFootbarEntries" cdkDropListOrientation="horizontal"
                        (cdkDropListDropped)="onParentDrop($event)">
                        @for (menu of visibleFootbarEntries; track menu.navitem.id) {
                        <li class="nav-item ms-3 d-flex align-items-center" cdkDrag [cdkDragData]="menu"
                            [cdkDragDisabled]="false" cdkDragBoundary="#footbarNav" [attr.data-nav-id]="menu.navitem.id"
                            (cdkDragStarted)="onDragStarted($event)" (cdkDragMoved)="onDragMoved()"
                            (cdkDragEnded)="onDragEnded()">
                            <ng-template cdkDragPreview>
                                <div class="nav-drag-preview d-inline-flex align-items-center p-2 bg-white border">
                                    <span class="drag-handle me-1"><i class="bi bi-grip-vertical text-muted"></i></span>
                                    <span class="drag-label">{{ label_transformer_simulation(menu.navitem) }}</span>
                                </div>
                            </ng-template>
                            <span class="drag-handle me-1" cdkDragHandle><i
                                    class="bi bi-grip-vertical text-muted"></i></span>
                            <button class="nav-link btn btn-link p-0" type="button" (click)="show_page(menu.navitem)">
                                {{ label_transformer_simulation(menu.navitem) }}
                                <i (click)="hasSandboxNavitems && editNavitem(menu.navitem); $event.stopPropagation()"
                                    [class]="'bi bi-pencil-square ms-1 ' + (hasSandboxNavitems ? 'text-success' : 'text-muted')"
                                    [style.cursor]="hasSandboxNavitems ? 'pointer' : 'not-allowed'"
                                    [style.opacity]="hasSandboxNavitems ? '1' : '0.5'"
                                    role="button" [title]="hasSandboxNavitems ? 'Éditer' : 'Sandbox vide - édition désactivée'"
                                    style="font-size: 0.75rem;"></i>
                            </button>
                        </li>
                        }
                    </ul>
                </div>
                <button class="btn btn-sm btn-outline-success ms-1" (click)="createNavItem(NAVITEM_POSITION.FOOTER)"
                    [disabled]="!hasSandboxNavitems"
                    [title]="hasSandboxNavitems ? 'Créer un nouvel élément de menu' : 'Sandbox vide - création désactivée'">
                    <i class="bi bi-plus-square-fill"></i>
                </button>
            </div>
        </nav>
    </ng-template>



    <ng-template #router_preview>
        <div class="alert alert-secondary" role="alert">
            {{ front_route_verbose }}

            @if (selected_page) {
            <h5>Page sélectionnée :</h5>
            <p><strong>Titre :</strong> {{ selected_page.title }}</p>
            <p><strong>Contenu :</strong></p>
            <!-- <div [innerHTML]="stringToSafeHtml(selected_page.content)"></div> -->
            }
        </div>
    </ng-template>

    <ng-template #menu_table>
        @for (position of ORDERED_NAVITEM_POSITIONS; track position) {
        @if (hasMenusForPosition(position)) {
        <div class="mb-4">
            <h6 class="text-primary">{{ position }}</h6>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Libellé</th>
                            <th>Type</th>
                            <th>Param.</th>
                            <th>Path</th>
                            <th>Rank</th>
                            <th>Visibilité</th>
                            <th>Préfixe label</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (entry of menus; let i = $index; track entry.navitem.id) {
                        @if (entry.navitem.position === position) {
                        <ng-container
                            *ngTemplateOutlet="menuTableRecursive; context: { $implicit: entry, parentIndex: getLocalIndexForPosition(i, position), indent: 0, position: entry.navitem.position }"></ng-container>
                        }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }
        }

        <!-- Template récursive pour la table des menus -->
        <ng-template #menuTableRecursive let-entry let-parentIndex="parentIndex" let-indent="indent"
            let-position="position">
            <tr>
                <td>{{ position }}-{{ parentIndex }}</td>
                <td [style.padding-left.px]="indent * 24"><strong>{{ entry.navitem.label }}</strong></td>
                <td>{{ entry.navitem.type }}</td>
                <td>{{ entry.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE ? entry.navitem.page_title :
                    (entry.navitem.type === NAVITEM_TYPE.PLUGIN ? entry.navitem.plugin_name :
                    (entry.navitem.type === NAVITEM_TYPE.DIRECT_CALL ? entry.navitem.slug : '')) }}</td>
                <td>{{ entry.navitem.path }}</td>
                <td>{{ entry.navitem.rank }}</td>
                <td>{{ entry.navitem.logging_criteria }}</td>
                <td>{{ entry.navitem.pre_label }}</td>
            </tr>
            @for (childGroup of entry.childs; let j = $index; track childGroup.navitem.id) {
            <ng-container
                *ngTemplateOutlet="menuTableRecursive; context: { $implicit: childGroup, parentIndex: parentIndex + '.' + (j + 1), indent: indent + 1, position: position }"></ng-container>
            }
        </ng-template>
    </ng-template>

    <ng-template #editNavitemOffcanvas let-offcanvas>
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Édition élément de menu</h5>
            <button type="button" class="btn-close text-reset" aria-label="Close"
                (click)="offcanvas.dismiss()"></button>
        </div>
        <div class="offcanvas-body">
            <form [formGroup]="navItemForm" class="vstack gap-3">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Position</label>
                        <select class="form-select" formControlName="position">
                            @for (pos of NAVITEM_POSITIONS; track pos) {<option [ngValue]="pos">{{ pos }}</option>}
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="previewLoggedSwitch"
                                    [(ngModel)]="previewLogged" [ngModelOptions]="{standalone:true}"
                                    (change)="onPreviewToggle($event.target.checked)">
                            </div>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Libellé</label>
                        <div class="input-group">
                            <select class="form-select" [ngModel]="currentLabelToken"
                                (ngModelChange)="useSpecialLabel($event)" [ngModelOptions]="{standalone:true}">
                                <option [ngValue]="''">— libellé libre —</option>
                                @for (tok of SPECIAL_LABELS; track tok) {<option [ngValue]="tok">{{ tok }}</option>}
                            </select>
                            <input type="text" class="form-control" formControlName="label"
                                placeholder="Texte du menu" />
                        </div>
                        <div class="form-text">Le champ est éditable uniquement avec "libellé libre".</div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Type</label>
                            <select class="form-select" formControlName="type">
                                @for (t of NAVITEM_TYPES; track t) {
                                <option [ngValue]="t"
                                    [disabled]="((navItemForm.get('parent_id')?.value != null) && (t === NAVITEM_TYPE.DROPDOWN)) || 
                                            ((navItemForm.get('position')?.value === NAVITEM_POSITION.FOOTER) && (t === NAVITEM_TYPE.DROPDOWN))">
                                    {{ t }}</option>
                                }
                            </select>
                            <div class="form-text" *ngIf="navItemForm.get('parent_id')?.value">
                                Les sous-menus ne peuvent pas être de type <strong>DROPDOWN</strong>.
                            </div>
                            <div class="form-text"
                                *ngIf="navItemForm.get('position')?.value === NAVITEM_POSITION.FOOTER">
                                Les menus footer ne peuvent pas être de type <strong>DROPDOWN</strong>.
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Parent (Dropdown)</label>
                            <select class="form-select" formControlName="parent_id">
                                <option [ngValue]="null">Aucun</option>
                                @for (n of navitems; track n.id) {
                                <option [ngValue]="n.id" [hidden]="n.type !== NAVITEM_TYPE.DROPDOWN">{{ n.path }}
                                </option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Visibilité</label>
                            <select class="form-select" formControlName="logging_criteria">
                                @for (crit of NAVITEM_LOGGING_CRITERIA_VALUES; track crit) {
                                <option [ngValue]="crit">{{ crit }}</option>
                                }
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Préfixe label</label>
                            <select class="form-select" formControlName="pre_label">
                                @for (pre of ['icon', 'avatar', null]; track pre) {
                                <option [ngValue]="pre">{{ pre }}</option>
                                }
                            </select>
                        </div>
                    </div>

                    @if (navItemForm.get('type')?.value === NAVITEM_TYPE.DIRECT_CALL) {
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label">Commande</label>
                            <select class="form-select" formControlName="command_name">
                                @for (c of NAVITEM_COMMANDS; track c) {<option [ngValue]="c">{{ c }}</option>}
                            </select>
                            <div class="form-text">Action exécutée au clic (sans navigation).</div>
                        </div>
                    </div>
                    } @else {
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Segment (slug)</label>
                            <input type="text" class="form-control" formControlName="slug" placeholder="ex: club"
                                [class.is-invalid]="navItemForm.get('type')?.value !== NAVITEM_TYPE.DROPDOWN && navItemForm.get('slug')?.invalid && (navItemForm.get('slug')?.dirty || navItemForm.get('slug')?.touched)" />
                            <div class="invalid-feedback">
                                Seuls les caractères minuscules, chiffres et '_' sont autorisés.
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Path (auto)</label>
                            <input type="text" class="form-control" formControlName="path" readonly />
                            <div class="form-text">Concatène le parent et le segment.</div>
                        </div>
                    </div>
                    }

                    @if (navItemForm.get('type')?.value === NAVITEM_TYPE.PLUGIN && navItemForm.get('plugin_name')?.value
                    ===
                    NAVITEM_PLUGIN.IFRAME) {
                    <div class="col-12">
                        <label class="form-label">URL externe</label>
                        <input type="url" class="form-control" formControlName="external_url"
                            placeholder="https://..." />
                    </div>
                    }
                    @if (navItemForm.get('type')?.value === NAVITEM_TYPE.EXTERNAL_REDIRECT && selectedNavitem) {
                    <div class="col-12">
                        <label class="form-label">URL externe à ouvrir</label>
                        <input id="externalUrlInput" type="url" class="form-control" formControlName="external_url"
                            placeholder="https://...">
                    </div>
                    }

                    @if (navItemForm.get('type')?.value === NAVITEM_TYPE.PLUGIN) {
                    <div class="col-12">
                        <label class="form-label">Plug-in</label>
                        <select class="form-select" formControlName="plugin_name">
                            @for (p of NAVITEM_PLUGINS; track p) {<option [ngValue]="p">{{ p }}</option>}
                        </select>
                    </div>
                    }

                    @if (navItemForm.get('type')?.value === NAVITEM_TYPE.CUSTOM_PAGE) {
                    <div class="col-12">
                        <label class="form-label">Page</label>
                        <select class="form-select" formControlName="page_id">
                            @for (pg of pages; track pg.id) {<option [ngValue]="pg.id">{{ pg.title }}</option>}
                        </select>
                    </div>
                    }

                    <div class="d-flex gap-2 justify-content-end mt-3">
                        <button type="button" class="btn btn-outline-secondary"
                            (click)="offcanvas.dismiss()">Annuler</button>
                        @if(selectedNavitem?.id){
                        <button type="button" class="btn btn-danger"
                            (click)="deleteNavitem(selectedNavitem!)">Supprimer</button>
                        }
                        <button type="button" class="btn btn-primary" (click)="saveNavitem()"
                            [disabled]="navItemForm.invalid">Enregistrer</button>
                    </div>
                </div>
            </form>
        </div>
    </ng-template>