<div class="container mt-4">
	<h3>Envoi d'email aux membres</h3>
	<div class="row">
		<!-- Colonne gauche : Formulaire -->
		<div class="col-md-6">
			<form (ngSubmit)="sendMail()" #mailForm="ngForm">
				<!-- S√©lection des destinataires -->
				<div class="mb-3">
					<label class="form-label">Destinataires</label>
					<div class="btn-group w-100 mb-2" role="group">
						<input type="radio" class="btn-check" name="recipientMode" id="modeAll" 
							[(ngModel)]="recipientMode" value="all" checked>
						<label class="btn btn-outline-primary" for="modeAll">
							Tous les membres ({{ members.length }})
						</label>
						
						<input type="radio" class="btn-check" name="recipientMode" id="modeSelected" 
							[(ngModel)]="recipientMode" value="selected">
						<label class="btn btn-outline-primary" for="modeSelected">
							S√©lection personnalis√©e
						</label>
					</div>
					
					<!-- Liste de s√©lection (visible uniquement en mode 'selected') -->
					<div *ngIf="recipientMode === 'selected'" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
						<div class="form-check" *ngFor="let member of members">
							<input class="form-check-input" type="checkbox" 
								[id]="'member-' + member.id" 
								[checked]="isMemberSelected(member.id)"
								[disabled]="!member.accept_mailing"
								(change)="toggleMemberSelection(member.id)">
							<label class="form-check-label small" [for]="'member-' + member.id"
								[class.text-muted]="!member.accept_mailing"
								[class.text-decoration-line-through]="!member.accept_mailing">
								{{ member.lastname }} {{ member.firstname }} ({{ member.email }})
								<span *ngIf="!member.accept_mailing" class="badge bg-secondary ms-1">Refus mailing</span>
							</label>
						</div>
					</div>
					<div *ngIf="recipientMode === 'selected'" class="small text-muted mt-1">
						{{ selectedMembers.length }} membre(s) s√©lectionn√©(s) ¬∑ 
						{{ getActiveMailingCount() }} acceptent les mailings sur {{ members.length }} membres
					</div>
				</div>
				<div class="mb-3">
					<label>Sujet</label>
					<input class="form-control" [(ngModel)]="subject" name="subject" required>
				</div>
				
				<!-- Pi√®ces jointes -->
				<div class="mb-3">
					<label class="form-label">Pi√®ces jointes</label>
					<input type="file" class="form-control" (change)="onFileSelected($event)" multiple 
						accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
					<div class="small text-muted mt-1">Formats accept√©s : PDF, Word, Excel, Images</div>
					
					<!-- Liste des pi√®ces jointes -->
					<div *ngIf="attachments.length > 0" class="mt-2">
						<div *ngFor="let attachment of attachments; let i = index" 
							class="d-flex align-items-center justify-content-between border rounded p-2 mb-1">
							<span class="small">
								üìé {{ attachment.filename }} 
								<span class="text-muted">({{ (attachment.content.length * 0.75 / 1024).toFixed(1) }} KB)</span>
							</span>
							<button type="button" class="btn btn-sm btn-danger" (click)="removeAttachment(i)">
								√ó
							</button>
						</div>
					</div>
				</div>
				
				<!-- √âditeur HTML -->
				<div class="mb-3">
					<label>Corps du texte</label>
					<!-- Barre d'outils de formatage -->
					<div class="btn-toolbar mb-2 border-bottom pb-2" role="toolbar">
						<div class="btn-group btn-group-sm me-2" role="group">
							<button type="button" class="btn btn-outline-primary" (click)="formatText('bold')" title="Gras">
								<strong>G</strong>
							</button>
							<button type="button" class="btn btn-outline-primary" (click)="formatText('italic')" title="Italique">
								<em>I</em>
							</button>
							<button type="button" class="btn btn-outline-primary" (click)="formatText('underline')" title="Soulign√©">
								<u>S</u>
							</button>
						</div>
						<div class="btn-group btn-group-sm me-2" role="group">
							<button type="button" class="btn btn-outline-primary" (click)="formatText('insertUnorderedList')" title="Liste √† puces">
								‚Ä¢ Liste
							</button>
							<button type="button" class="btn btn-outline-primary" (click)="formatText('insertOrderedList')" title="Liste num√©rot√©e">
								1. Liste
							</button>
						</div>
						<div class="btn-group btn-group-sm" role="group">
							<button type="button" class="btn btn-outline-primary" (click)="formatText('formatBlock', '<h3>')" title="Titre">
								H3
							</button>
							<button type="button" class="btn btn-outline-primary" (click)="formatText('formatBlock', '<p>')" title="Paragraphe">
								P
							</button>
						</div>
					</div>
					
					<div 
						#editorDiv
						contenteditable="true" 
						class="form-control editor-content" 
						style="min-height: 400px; overflow-y: auto;"
						(input)="onContentChange($event)"
						(blur)="onContentChange($event)"
						data-placeholder="Tapez ou collez votre contenu ici (HTML format√© accept√©)...">
					</div>
					<input type="hidden" name="bodyHtml" [(ngModel)]="bodyHtml" required>
				</div>
			</form>
		</div>
		
		<!-- Colonne droite : Pr√©visualisation -->
		<div class="col-md-6">
			<div class="sticky-top" style="top: 20px;">
				<h5>Pr√©visualisation</h5>
				<div class="border rounded p-2 mb-3" style="background-color: #f9f9f9; max-height: 60vh; overflow-y: auto;">
					<div [innerHTML]="getFullPreview()"></div>
				</div>
				
				<!-- Bouton d'envoi et r√©sultats -->
				<button class="btn btn-success w-100 mb-2" [disabled]="sending || !mailForm.form.valid" (click)="sendMail()">
					<span *ngIf="sending" class="spinner-border spinner-border-sm me-2"></span>
					Envoyer
				</button>
				
				<div *ngIf="result" class="alert alert-success">
					‚úÖ Envoi r√©ussi ! {{ result.sentCount }} email(s) envoy√©(s).
					<div *ngIf="skippedRecipients.length > 0" class="mt-2">
						<strong>‚ö†Ô∏è {{ skippedRecipients.length }} destinataire(s) exclu(s)</strong> (ont refus√© les mailings) :
						<ul class="mb-0 mt-1 small">
							<li *ngFor="let email of skippedRecipients">{{ email }}</li>
						</ul>
					</div>
				</div>
				<div *ngIf="error" class="alert alert-danger">‚ùå Erreur : {{ error }}</div>
			</div>
		</div>
	</div>
</div>
