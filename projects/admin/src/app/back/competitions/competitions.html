<div class="container-fluid py-3">
    <div class="row">
        <div *ngIf="back_office_mode" class="col-12 mb-3 mb-md-0">
            <!-- Bloc back-office uniquement -->
            <div *ngIf="back_office_mode" class="card mb-3 mt-5 shadow-sm">
                <div class="card-header ">
                    <span class="fw-bolder text-center d-block mb-3">Mode back-office - réglage des paramètres
                        d'affichage</span>

                    <!-- <div class="row"> -->
                    <div class="col-auto d-flex flex-column gap-2">
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="showMembersOnlyBack"
                                [(ngModel)]="ui_config_loaded.competitions.show_members_only"
                                (change)="onParamsChange(false)" />
                            <label class="form-check-label" for="showMembersOnlyBack">Membres uniquement</label>
                        </div>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="showTheoricalRankBack"
                                [(ngModel)]="ui_config_loaded.competitions.show_infos"
                                (change)="onParamsChange(false)" />
                            <label class="form-check-label" for="showTheoricalRankBack">Données détaillées</label>
                        </div>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="oneYearBackBack"
                                [(ngModel)]="ui_config_loaded.competitions.one_year_back"
                                (change)="onParamsChange(true)" />
                            <label class="form-check-label" for="oneYearBackBack">Saison précédente</label>
                        </div>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="noFilterBack"
                                [(ngModel)]="ui_config_loaded.competitions.no_filter"
                                (change)="onParamsChange(false)" />
                            <label class="form-check-label" for="noFilterBack">Aucun filtrage</label>
                        </div>

                        <!-- <div class="col-auto flex-grow-1"> -->
                        <div class="d-flex flex-column align-items-stretch ms-3">
                            <!-- <label class="form-check-label">Seuils de filtrage par division</label> -->
                            <div *ngFor="let division of divisions; let i = index">
                                <div *ngIf="back_office_mode " class=" w-100 mb-1">
                                    <div class="d-flex align-items-center w-100 mx-auto">
                                        <div class="small text-start me-2" style="width: 120px;">
                                            {{ division }}
                                        </div>
                                        <input type="range" class="form-range" style="width: 200px;"
                                            [(ngModel)]="ui_config_loaded.competitions.result_filter_thresholds[division]"
                                            min="1" max="100" step="1" (change)="onParamsChange(false)"
                                            [disabled]="ui_config_loaded.competitions.no_filter" />
                                        <span class="badge bg-secondary ms-2" style="min-width: 40px; text-align: center;">{{
                                            ui_config_loaded.competitions.result_filter_thresholds[division]
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <button [disabled]="!thresholdsModified" class="btn btn-primary btn-sm ms-auto mt-1"
                            (click)="saveThresholds()">Sauvegarder</button>
                    </div>
                    <!-- </div> -->
                </div>
            </div>
        </div>
        <div class="col-12 col-md">


            <div *ngIf="!results_extracted" class="row mb-3 justify-content-center">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <div>
                        {{ spinnerMessage }}
                    </div>
                </div>
            </div>

            <div *ngIf="results_extracted">

                <!-- Bloc résultats -->
                <div *ngIf="(filtered_team_results | keyvalue).length > 0"
                    class="row mb-3" style="gap:0;">
                    <div *ngIf="results_extracted && (filtered_team_results | keyvalue).length === 0"
                        class="alert alert-info text-center my-4">
                        Aucun résultat à afficher pour la saison {{current_season}}.
                    </div>
                    <div class="division-col px-1 col-12 col-md" *ngFor="let division of divisions; let i = index"
                        style="min-width:120px;">
                        <div class="fw-bold text-center mb-2" style="font-size:0.95em;">
                            {{ division }}
                        </div>
                        <div class="d-flex flex-column gap-1" style="font-size:0.85em;">
                            <ng-container *ngFor="let result of filtered_team_results | keyvalue">
                                <!-- result.key = competitionId, result.value = CompetitionResults[] -->
                                <ng-container *ngIf="result.value.length > 0 && hasTeamsToDisplay(result.value)"
                                    [ngTemplateOutlet]="competitionCard" [ngTemplateOutletContext]="{
                                                        divisionCategory: result.value[0].competition.assigned_division,
                                                        result: result,
                                                        division: division
                                                    }">
                                </ng-container>
                                <ng-template #competitionCard let-divisionCategory="divisionCategory"
                                    let-result="result" let-division="division">
                                    <ng-container *ngIf="divisionCategory === division">
                                        <div class="card shadow-sm" style="font-size:0.85em;">
                                            <div class="card-header text-center" style="font-size:0.9em;">
                                                <span class="fw-bold">
                                                    {{ result.value[0].competition.assigned_label }}
                                                </span>
                                                <div *ngIf="show_infos" style="font-size: 0.7em;">{{result.key}}
                                                    {{result.value[0].competition.family.label}} - {{
                                                    (result.value[0].competition.label) }}</div>
                                            </div>
                                            <div class="card-body p-2">
                                                <ng-container *ngFor="let res of result.value; let i = index">
                                                    <div class="mb-2">
                                                        <ng-container *ngIf="i > 0">
                                                            <hr class="my-2">
                                                        </ng-container>
                                                        <div *ngIf="getFilteredTeams(res).length !== 0"
                                                            class="text-primary mb-1">
                                                            {{ get_organization_label(res.competition.organization_id)
                                                            }}
                                                        </div>
                                                        <ng-container *ngFor="let team of getFilteredTeams(res)">
                                                            <div class="mb-2">
                                                                <div class="d-flex align-items-center">
                                                                    <span
                                                                        class="me-2 d-flex flex-column align-items-center rank-style">
                                                                        <span>
                                                                            {{ team.rank + (team.rank===1?'er':'eme') }}
                                                                        </span>
                                                                        <span *ngIf="show_infos"
                                                                            style="font-size: 0.7em;">
                                                                            {{(team.cumulated_pe_percentage ?
                                                                            (team.cumulated_pe_percentage |
                                                                            number:'1.0-1') +
                                                                            '%' :
                                                                            '') }}
                                                                        </span>
                                                                    </span>
                                                                    <span
                                                                        class="ms-3 d-flex flex-row flex-grow-1 w-100 justify-content-between align-items-start">
                                                                        <ng-container
                                                                            *ngIf="show_members_only; else playersColumn">
                                                                            <span>
                                                                                <ng-container
                                                                                    *ngFor="let player of getDisplayedPlayers(team.players); let i = index; let last = last">
                                                                                    <span
                                                                                        [ngClass]="{'fw-semibold': isMember(player), 'fst-italic': !isMember(player), 'player-small': true}">
                                                                                        {{ player.firstname }} {{
                                                                                        player.lastname }}
                                                                                    </span>
                                                                                    <ng-container *ngIf="!last"> -
                                                                                    </ng-container>
                                                                                </ng-container>
                                                                            </span>
                                                                        </ng-container>
                                                                        <ng-template #playersColumn>
                                                                            <span class="d-flex flex-column">
                                                                                <span
                                                                                    *ngFor="let player of team.players">
                                                                                    <span
                                                                                        *ngIf="isMember(player) || !show_members_only"
                                                                                        [ngClass]="{'fw-semibold': isMember(player), 'fst-italic': !isMember(player), 'player-small': true}">
                                                                                        {{ player.firstname }} {{
                                                                                        player.lastname }}
                                                                                    </span>
                                                                                </span>
                                                                            </span>
                                                                        </ng-template>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </ng-container>
                                                    </div>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </ng-container>
                                </ng-template>
                            </ng-container>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-center" style="font-size: 0.6em;">résultats à date pour la saison
                    {{current_season}} -
                    données FFB
                </div>
            </div>

        </div>
    </div>

</div>