<div class="container ui-conf-root">
  <form [formGroup]="uiForm" (ngSubmit)="saveSettings()">
    <div class="row row-cols-1 row-cols-md-2 g-3">
      <!-- section Thème -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Paramétrage interface utilisateur</div>
          <div class="card-body">
            <div class="mb-3 row">
              <div class="col-12 col-md-6">
                <!-- Couleurs du front -->
                <div class="fw-bold small mb-1 mt-2 text-primary">Couleurs du front&nbsp;:</div>
                <div class="d-flex align-items-center mb-0" style="gap:0.25rem; min-height:1.8rem;">
                  <input type="color" style="width:1.6rem;height:1.6rem;padding:0;border:none;"
                    formControlName="header_bg" (change)="applyTheme()">
                  <label class="form-label mb-0 flex-grow-1" style="font-size:0.95em;">Bandeau supérieur & Barre de titre</label>
                </div>
                <div class="d-flex align-items-center mb-0" style="gap:0.25rem; min-height:1.8rem;">
                  <input type="color" style="width:1.6rem;height:1.6rem;padding:0;border:none;"
                    formControlName="navbar_bg" (change)="applyTheme()">
                  <label class="form-label mb-0 flex-grow-1" style="font-size:0.95em;">Navbar</label>
                </div>
                <div class="d-flex align-items-center mb-0" style="gap:0.25rem; min-height:1.8rem;">
                  <input type="color" style="width:1.6rem;height:1.6rem;padding:0;border:none;"
                    formControlName="footer_bg" (change)="applyTheme()">
                  <label class="form-label mb-0 flex-grow-1" style="font-size:0.95em;">Pied de page</label>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <!-- Polices -->
                <div class="mb-2">
                  <label class="form-label fw-bold mb-0">Police principale</label>
                  <input type="text" class="form-control form-control-sm" formControlName="main_font"
                    placeholder="ex: Amarante, serif" (change)="applyTheme()">
                </div>
                <div class="mb-2">
                  <label class="form-label fw-bold mb-0">Police des titres</label>
                  <input type="text" class="form-control form-control-sm" formControlName="title_font"
                    placeholder="ex: Emblema One, cursive" (change)="applyTheme()">
                </div>
              </div>
            </div>
            <!-- Bouton Enregistrer accessible en bas de la section -->
            <div class="d-flex justify-content-end mt-2">
              <button type="submit" class="btn btn-success btn-sm"
                [disabled]="uiForm.invalid || uiForm.get('tournaments_row_cols')?.invalid">Enregistrer</button>
            </div>
          </div>
        </div>
      </div>
      <!-- section Accueil -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">page d'Accueil</div>
          <div class="card-body">
            <div class="fw-bold fs-6">Colonnes tournois et news</div>
            <div class="mb-2 d-flex align-items-center gap-3">
              <label class="form-label small mb-0">distribution colonnes :</label>
              <div class="input-group input-group-sm" style="max-width:14rem;">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" id="homeLayout0" formControlName="home_layout_ratio"
                    [value]="0">
                  <label class="form-check-label" for="homeLayout0">1:2</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" id="homeLayout1" formControlName="home_layout_ratio"
                    [value]="1">
                  <label class="form-check-label" for="homeLayout1">1:1</label>
                </div>
                <div class="form-check form-check-inline ms-2">
                  <input class="form-check-input" type="radio" id="homeLayout2" formControlName="home_layout_ratio"
                    [value]="2">
                  <label class="form-check-label" for="homeLayout2">2:1</label>
                </div>
              </div>
            </div>
            <ng-container
              *ngTemplateOutlet="breakpointsInputs; context: { groupName: 'tournaments_row_cols', label: 'Tournois par ligne' }"></ng-container>
            <ng-container
              *ngTemplateOutlet="breakpointsInputs; context: { groupName: 'news_row_cols', label: 'News par ligne' }"></ng-container>

            <button type="button" class="btn btn-secondary btn-sm" (click)="previewSettings()"
              [disabled]="uiForm.get('tournaments_row_cols')?.invalid">Aperçu</button>



            <div class="fw-bold fs-6">Paramètres de dépliage des news</div>

            <div class="mt-2 d-flex align-items-center gap-2">
              <span class="small text-nowrap flex-shrink-0">Lignes avant «Lire la suite»</span>
              <div class="input-group input-group-sm" style="max-width:4rem;">
                <input type="number" class="form-control form-control-sm text-center" formControlName="read_more_lines"
                  min="0" max="20" />
              </div>
              <small class="text-muted ms-2">0 = tout le texte</small>
            </div>

            <div class="mt-2 d-flex align-items-center gap-2">
              <span class="small text-nowrap flex-shrink-0">Mode de dépliement :</span>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="unfoldOnHover"
                  formControlName="unfold_on_hover">
                <label class="form-check-label visually-hidden" for="unfoldOnHover">Déplier au survol</label>
              </div>
              <small class="text-muted ms-2">{{ unfoldOnHover ? 'Ouverture en ligne' : 'Navigation vers la page'
                }}</small>
            </div>

            <div *ngIf="unfoldOnHover" class="mt-2 d-flex align-items-center gap-2">
              <span class="small text-nowrap flex-shrink-0">délai | durée</span>
              <div class="input-group input-group-sm" style="max-width:14rem;">
                <input type="number" class="form-control form-control-sm text-center"
                  formControlName="hover_unfold_delay_ms" min="0" max="10000"
                  style="max-width:6rem;font-size:0.85rem;" />
                <input type="number" class="form-control form-control-sm text-center ms-2"
                  formControlName="hover_unfold_duration_ms" min="0" max="10000"
                  style="max-width:6rem;font-size:0.85rem;" />
              </div>
              <small class="text-muted ms-2">exprimés en millisecondes</small>
            </div>
          </div>
        </div>
      </div>
      <!-- vignettes tournois -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Vignettes tournois</div>
          <div class="card-body">
            <div formArrayName="tournaments_type">
              <div *ngFor="let ctrl of tournaments_type.controls; let i = index" [formGroupName]="i"
                class="d-flex align-items-center gap-2 mb-2">
                <input type="text" class="form-control form-control-sm" placeholder="keyword" formControlName="key"
                  style="max-width: 180px;" />

                <select class="form-select form-select-sm" formControlName="image" style="min-width: 240px;">
                  <option value="">-- aucune --</option>
                  <option *ngFor="let t of (thumbnails$ | async)" [value]="t">{{ t }}</option>
                </select>

                <div class="preview ms-2">
                  <img *ngIf="ctrl.get('key')?.value && previewMap[ctrl.get('key')?.value]"
                    [src]="previewMap[ctrl.get('key')?.value]" alt="thumb"
                    style="height:36px;object-fit:cover;border-radius:4px;" />
                </div>

                <button type="button" class="btn btn-outline-danger btn-sm ms-auto"
                  (click)="removeTournamentType(i)">Supprimer</button>
              </div>
            </div>

            <div class="mt-2">
              <div *ngIf="tournaments_type.errors?.['emptyKey']" class="small text-danger">Chaque mapping doit avoir une
                clé
                non vide.</div>
              <div *ngIf="tournaments_type.errors?.['duplicateKeys']" class="small text-danger">Clés en double: {{
                (tournaments_type.errors?.['duplicateKeys'] || []).join(', ') }}</div>
            </div>

            <div class="mt-2 d-flex align-items-center gap-3">
              <button type="button" class="btn btn-outline-success btn-sm" (click)="addTournamentType()">Ajouter un
                mapping</button>
              <div class="small text-muted">Associez un mot-clé de tournoi à une image vignette.</div>
            </div>

            <hr />
            <!-- Integrated default row -->
            <div class="small text-muted">Image utilisée quand aucun mot-clé ne correspond.</div>
            <div class="d-flex align-items-center gap-2 mt-2 mb-2">
              <input type="text" class="form-control form-control-sm" value="défaut" disabled
                style="max-width: 180px;" />
              <select class="form-select form-select-sm" formControlName="default_tournament_image"
                style="min-width: 240px;">
                <option value="">-- aucune --</option>
                <option *ngFor="let t of (thumbnails$ | async)" [value]="t">{{ t }}</option>
              </select>
              <div class="preview ms-2">
                <img *ngIf="previewMap['defaut']" [src]="previewMap['defaut']" alt="thumb"
                  style="height:36px;object-fit:cover;border-radius:4px;" />
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col">
        <!-- Section Emails -->
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Emails</div>
          <div class="card-body" formGroupName="email">
            <div class="mb-3">
              <label class="form-label">Accroche en-tête email</label>
              <input type="text" class="form-control" formControlName="tagline"
                placeholder="Votre club de bridge convivial et dynamique" autocomplete="organization-title"
                name="email-tagline">
              <div class="small text-muted mt-1">Texte affiché sous le titre dans l'en-tête des emails</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Email en copie (CC)</label>
              <input type="email" class="form-control" formControlName="ccEmail" placeholder="exemple@domaine.fr"
                autocomplete="email" name="cc-email-address">
              <div class="small text-muted mt-1">Adresse email qui recevra une copie de tous les mailings</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section images sizing -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Taille des vignettes articles</div>
          <div class="card-body">
            <!-- <div class="row row-cols-1 row-cols-md-2 g-3"> -->
            <div class="row">
              <div class="d-flex align-items-center mb-2">
                <span class="fw-bold fs-6">Vignettes articles</span>
                <button type="button" class="btn btn-outline-success btn-sm ms-3" (click)="addCardThumbnail()">Ajouter
                  une taille</button>
              </div>
              <div formArrayName="card_thumbnails">
                <div *ngFor="let thumb of card_thumbnails.controls; let i = index" [formGroupName]="i"
                  class="mb-2 border rounded p-2">
                  <div class="d-flex align-items-center gap-3">
                    <span class="form-label mb-0 text-nowrap flex-shrink-0">Taille {{i+1}} :</span>
                    <div class="input-group input-group-sm" style="max-width:10rem;">
                      <span class="input-group-text">Largeur (px)</span>
                      <input type="number" class="form-control form-control-sm text-center" formControlName="width"
                        min="50" max="2000" />
                    </div>
                    <div class="input-group input-group-sm" style="max-width:10rem;">
                      <span class="input-group-text">Hauteur (px)</span>
                      <input type="number" class="form-control form-control-sm text-center" formControlName="height"
                        min="50" max="2000" />
                    </div>
                    <div class="input-group input-group-sm" style="max-width:8rem;">
                      <span class="input-group-text">Ratio</span>
                      <input type="number" class="form-control form-control-sm text-center" formControlName="ratio"
                        min="0.1" max="10" step="0.01" />
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm ms-2" (click)="removeCardThumbnail(i)"
                      [disabled]="card_thumbnails.length === 1">×</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="fw-bold fs-6 mb-2">Vignettes albums</div>
              <div formGroupName="album_thumbnail">
                <div class="d-flex align-items-center gap-3 mb-2">
                  <span class="form-label mb-0 text-nowrap flex-shrink-0">Taille :</span>
                  <div class="input-group input-group-sm" style="max-width:10rem;">
                    <span class="input-group-text">Largeur (px)</span>
                    <input type="number" class="form-control form-control-sm text-center" formControlName="width"
                      min="50" max="2000" />
                  </div>
                  <div class="input-group input-group-sm" style="max-width:10rem;">
                    <span class="input-group-text">Hauteur (px)</span>
                    <input type="number" class="form-control form-control-sm text-center" formControlName="height"
                      min="50" max="2000" />
                  </div>
                </div>
              </div>
            </div>
            <!-- </div> -->
          </div>
        </div>
      </div>

      <!-- Section album carousel interval -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Carousel d'albums</div>
          <div class="card-body">
            <div class="d-flex align-items-center gap-2">
              <span class="form-label mb-0 text-nowrap flex-shrink-0">Intervalle de défilement automatique (ms) :</span>
              <div class="input-group input-group-sm" style="max-width:8rem;">
                <input type="number" class="form-control form-control-sm text-center"
                  formControlName="album_carousel_interval_ms" min="0" max="60000" />
              </div>
              <small class="text-muted ms-2">0 = désactivé</small>
            </div>
          </div>
        </div>
      </div>
      <!-- Section Résultats compétitions -->
      <div class="col">
        <div class="card h-100">
          <div class="card-title fw-bold fs-5 ms-2">Résultats compétitions</div>
          <div class="card-body" formGroupName="competitions">
            <div class="mb-2">
              <label class="form-label">Sélection</label>
              <input type="text" class="form-control" formControlName="preferred_organizations"
                placeholder="Séparez par des virgules" />
              <div class="small text-muted mt-1">Exemple : FFB, Ligue 06 LR-PY, Comité des Pyrenees</div>
            </div>
            <div class="mb-2 form-check">
              <input type="checkbox" class="form-check-input" id="showMembersOnly"
                formControlName="show_members_only" />
              <label class="form-check-label" for="showMembersOnly">Afficher uniquement les membres dans les
                équipes</label>
            </div>
            <div class="mb-2 form-check">
              <input type="checkbox" class="form-check-input" id="oneYearBack" formControlName="one_year_back" />
              <label class="form-check-label" for="oneYearBack">Afficher la saison précédente</label>
            </div>
            <div class="mb-2 form-check">
              <input type="checkbox" class="form-check-input" id="showTheoricalRank"
                formControlName="show_theorical_rank" />
              <label class="form-check-label" for="showTheoricalRank">Afficher le rang théorique</label>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Import/Export/store Action buttons -->
    <div class="col-12 d-flex gap-2 justify-content-end mt-2 bg-body-secondary p-2 rounded">
      <input type="file" accept="application/json" (change)="onImportFile($event)"
        class="form-control form-control-sm w-auto" />
      <a [href]="export_file_url" download="ui_settings.json" class="btn btn-outline-success btn-sm">Export</a>
      <small class="text-muted align-self-center ms-2">sauvegarde</small>
      <button type="submit" class="btn btn-success btn-sm"
        [disabled]="uiForm.invalid || uiForm.get('tournaments_row_cols')?.invalid">Enregistrer</button>
    </div>

    <!-- // compact template for breakpoints inputs -->
    <ng-template #breakpointsInputs let-groupName="groupName" let-label="label">
      <div [formGroupName]="groupName" class="w-100">
        <div class="d-flex align-items-center gap-3">
          <span class="form-label mb-0 text-nowrap flex-shrink-0">{{ label }} (sm|md|lg|xl) : </span>
          <div class="input-group input-group-sm">
            <input type="number" class="form-control form-control-sm text-center" formControlName="SM" min="1" max="6"
              style="max-width:3rem;font-size:0.85rem;" />
            <input type="number" class="form-control form-control-sm text-center" formControlName="MD" min="1" max="6"
              style="max-width:3rem;font-size:0.85rem;" />
            <input type="number" class="form-control form-control-sm text-center" formControlName="LG" min="1" max="6"
              style="max-width:3rem;font-size:0.85rem;" />
            <input type="number" class="form-control form-control-sm text-center" formControlName="XL" min="1" max="6"
              style="max-width:3rem;font-size:0.85rem;" />
          </div>
        </div>
        <div class="mt-1 d-flex gap-3 small text-danger">
          <span
            *ngIf="uiForm.get(groupName + '.SM')?.invalid && (uiForm.get(groupName + '.SM')?.touched || uiForm.get(groupName + '.SM')?.dirty)">
            SM: 1–6
          </span>
          <span
            *ngIf="uiForm.get(groupName + '.MD')?.invalid && (uiForm.get(groupName + '.MD')?.touched || uiForm.get(groupName + '.MD')?.dirty)">
            MD: 1–6
          </span>
          <span
            *ngIf="uiForm.get(groupName + '.LG')?.invalid && (uiForm.get(groupName + '.LG')?.touched || uiForm.get(groupName + '.LG')?.dirty)">
            LG: 1–6
          </span>
          <span
            *ngIf="uiForm.get(groupName + '.XL')?.invalid && (uiForm.get(groupName + '.XL')?.touched || uiForm.get(groupName + '.XL')?.dirty)">
            XL: 1–6
          </span>
        </div>
        <div class="mt-1 small text-danger" *ngIf="uiForm.get(groupName)?.hasError('breakpointsOrder')">
          Les valeurs doivent être croissantes : SM ≤ MD ≤ LG ≤ XL
        </div>
      </div>
    </ng-template>

  </form>

</div>