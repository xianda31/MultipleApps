<nav class="navbar navbar-expand-md navbar-dark text-white d-flex align-items-center">
  <div class="container-fluid h-100 d-flex align-items-center">
    <a class="navbar-brand d-flex align-items-center position-relative" [routerLink]="brandPath">
      {{ brandLabel }}
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
      aria-controls="sidebarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse d-none d-md-flex align-items-center position-relative">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <!-- Dynamic navbar from configured menus -->
        <ng-container *ngTemplateOutlet="dyn_navbar_nav"></ng-container>

      </ul>
    </div>

    <!-- Sidebar for mobile -->
    <div class="offcanvas offcanvas-start d-md-none bg-white text-dark align-items-start " tabindex="-1"
      id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarMenuLabel">BCSTO</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">

        <ul class="navbar-nav">

          <!-- Dynamic navbar for mobile from configured menus -->
          <ng-container *ngTemplateOutlet="dyn_navbar_nav_mobile"></ng-container>

        </ul>
      </div>
    </div>


  </div>
</nav>
 

<ng-template #dyn_navbar_nav>
  @for (menu of navbar_menus; track menu.navitem.id) {
  @if (menu.navitem.position === NAVITEM_POSITION.NAVBAR && 
       ((menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
        || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY && (logged_member$ | async))
        || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY && !(logged_member$ | async)))) {
  <ng-container *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: menu }"></ng-container>
  }
  }
  <!-- Template rÃ©cursive pour MenuGroup_new -->
  <ng-template #menuGroupRecursive let-menu>
    @if (menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0) {
    <li class="nav-item dropdown ms-3" ngbDropdown>
      <a class="nav-link dropdown-toggle" ngbDropdownToggle id="nav-{{ menu.navitem.id }}">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        {{ label_transformer(menu.navitem.label) | async }}
      </a>
      <ul class="dropdown-menu" ngbDropdownMenu [attr.aria-labelledby]="'nav-' + menu.navitem.id">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: child }"></ng-container>
        }
      </ul>
    </li>
    }
    @else {
    <li class="nav-item ms-3">
      @if (menu.navitem.type === NAVITEM_TYPE.EXTERNAL_REDIRECT) {
      <a class="dropdown-item" [href]="menu.navitem.external_url" target="_blank" rel="noopener">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.INTERNAL_LINK) {
      <a class="dropdown-item" [routerLink]="menu.navitem.path">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type?.toLowerCase() === 'plugin') {
      <a class="dropdown-item Plugin" [routerLink]="menu.navitem.path"
        [queryParams]="{ external_url: menu.navitem.external_url }">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE) {
      <a class="dropdown-item Page" [routerLink]="menu.navitem.path">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.DIRECT_CALL) {
      <a class="dropdown-item" (click)="onCommand(menu.navitem)">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else {
      <span class="dropdown-item text-danger">Type de menu inconnu</span>
      }
    </li>
    }
  </ng-template>
</ng-template>


<!-- Mobile version with data-bs-dismiss for offcanvas -->
<ng-template #dyn_navbar_nav_mobile>
  @for (menu of navbar_menus; track menu.navitem.id) {
  @if (menu.navitem.position === NAVITEM_POSITION.NAVBAR && 
       ((menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
        || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY && (logged_member$ | async))
        || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY && !(logged_member$ | async)))) {
  <ng-container *ngTemplateOutlet="menuGroupRecursiveMobile; context: { $implicit: menu }"></ng-container>
  }
  }
  <ng-template #menuGroupRecursiveMobile let-menu>
    @if (menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0) {
    <li class="nav-item dropdown" ngbDropdown>
      <a class="nav-link dropdown-toggle" ngbDropdownToggle id="nav-mobile-{{ menu.navitem.id }}">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        {{ label_transformer(menu.navitem.label) | async }}
      </a>
      <ul class="dropdown-menu" ngbDropdownMenu [attr.aria-labelledby]="'nav-mobile-' + menu.navitem.id">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container *ngTemplateOutlet="menuGroupRecursiveMobile; context: { $implicit: child }"></ng-container>
        }
      </ul>
    </li>
    }
    @else {
    <li class="nav-item">
      @if (menu.navitem.type === NAVITEM_TYPE.EXTERNAL_REDIRECT) {
      <a class="dropdown-item" [href]="menu.navitem.external_url" target="_blank" rel="noopener" data-bs-dismiss="offcanvas">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.INTERNAL_LINK) {
      <a class="dropdown-item" [routerLink]="menu.navitem.path" data-bs-dismiss="offcanvas">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type?.toLowerCase() === 'plugin') {
      <a class="dropdown-item Plugin" [routerLink]="menu.navitem.path"
        [queryParams]="{ external_url: menu.navitem.external_url }" data-bs-dismiss="offcanvas">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE) {
      <a class="dropdown-item Page" [routerLink]="menu.navitem.path" data-bs-dismiss="offcanvas">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else if (menu.navitem.type === NAVITEM_TYPE.DIRECT_CALL) {
      <a class="dropdown-item" (click)="onCommand(menu.navitem)" data-bs-dismiss="offcanvas">
        <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
      </a>
      }
      @else {
      <span class="dropdown-item text-danger">Type de menu inconnu</span>
      }
    </li>
    }
  </ng-template>
</ng-template>


<!-- Shared label template for both desktop and mobile -->
<ng-template #menuLabelTemplate let-menu>
  @if(menu.navitem.pre_label === 'avatar') {
  <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
    style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
  }
  {{ label_transformer(menu.navitem.label) | async }}
</ng-template>
