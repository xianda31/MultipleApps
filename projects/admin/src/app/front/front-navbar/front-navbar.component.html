<nav class="navbar navbar-expand-md navbar-dark text-white d-flex align-items-center">
  <div class="container-fluid h-100 d-flex align-items-center">
    @if (brandNavitem) {
    <a class="navbar-brand d-flex align-items-center position-relative main-nav-link align-middle"
      [routerLink]="brandNavitem.path">
      <span class="align-middle">{{ brandNavitem.label }}</span>
    </a>
    }
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
      aria-controls="sidebarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Desktop menu -->
    <div class="collapse navbar-collapse d-none d-md-flex align-items-center position-relative">
      <ul class="navbar-nav me-auto  mb-lg-0">
        <ng-container *ngTemplateOutlet="dyn_navbar_unified; context: { isMobile: false }"></ng-container>
      </ul>
    </div>

    <!-- Sidebar for mobile -->
    <div class="offcanvas offcanvas-start d-md-none bg-white text-dark" tabindex="-1"
      id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header flex-column align-items-start py-1">
        <div class="d-flex w-100 justify-content-between align-items-center ">
          <img src="bcsto_ffb.jpg" alt="BCSTO Logo" style="height:35px;">
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <!-- @if (brandNavitem) {
        <a class="navbar-brand d-flex align-items-center mt-2" [routerLink]="brandNavitem.path" data-bs-dismiss="offcanvas">
          <span>{{ brandNavitem.label }}</span>
        </a>
        } -->
      </div>
      <div class="offcanvas-body p-1">
        <ul class="navbar-nav">
          <ng-container *ngTemplateOutlet="dyn_navbar_unified; context: { isMobile: true }"></ng-container>
        </ul>
      </div>
    </div>

  </div>
</nav>


<ng-template #dyn_navbar_unified let-isMobile="isMobile">
  @for (menu of navbar_menus; track menu.navitem.id) {
  @if (menu.navitem.position === NAVITEM_POSITION.NAVBAR &&
  ((menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
  || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY && (logged_member$ | async))
  || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY && !(logged_member$ | async)))) {
  <ng-container *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: menu, isMobile: isMobile }"></ng-container>
  }
  }
</ng-template>

<!-- Template récursive unifiée pour MenuGroup -->
<ng-template #menuGroupRecursive let-menu let-isMobile="isMobile">
  @if (menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0) {
    <!-- Desktop: dropdown avec ngbDropdown -->
    @if (!isMobile) {
    <li class="nav-item dropdown ms-3" ngbDropdown>
      <a class="nav-link main-nav-link dropdown-toggle" ngbDropdownToggle
        [id]="'nav-' + menu.navitem.id">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        <span>{{ label_transformer(menu.navitem.label) | async }}</span>
      </a>
      <ul class="dropdown-menu" ngbDropdownMenu [attr.aria-labelledby]="'nav-' + menu.navitem.id">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container
          *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: child, isMobile: isMobile }"></ng-container>
        }
      </ul>
    </li>
    }
    <!-- Mobile: liste dépliée sans dropdown -->
    @else {
    <li class="nav-item mobile-submenu-parent">
      <span class="dropdown-item">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        {{ label_transformer(menu.navitem.label) | async }}
      </span>
      <ul class="navbar-nav ms-3">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container
          *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: child, isMobile: isMobile }"></ng-container>
        }
      </ul>
    </li>
    }
  }
  @else {
  <li [class]="isMobile ? 'nav-item' : 'nav-item ms-3'">
    @if (menu.navitem.type === NAVITEM_TYPE.EXTERNAL_REDIRECT) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" [href]="menu.navitem.external_url"
      target="_blank" rel="noopener" [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.INTERNAL_LINK) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" [routerLink]="menu.navitem.path"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type?.toLowerCase() === 'plugin') {
    <a [class]="isMobile ? 'dropdown-item Plugin' : 'nav-link main-nav-link Plugin'" [routerLink]="menu.navitem.path"
      [queryParams]="{ external_url: menu.navitem.external_url }"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE) {
    <a [class]="isMobile ? 'dropdown-item Page' : 'nav-link main-nav-link Page'" [routerLink]="menu.navitem.path"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.DIRECT_CALL) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" (click)="onCommand(menu.navitem)"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else {
    <span class="dropdown-item text-danger">Type de menu inconnu</span>
    }
  </li>
  }
</ng-template>


<!-- Shared label template for both desktop and mobile -->
<ng-template #menuLabelTemplate let-menu>
  @if(menu.navitem.pre_label === 'avatar') {
  <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
    style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
  }
  {{ label_transformer(menu.navitem.label) | async }}
</ng-template>