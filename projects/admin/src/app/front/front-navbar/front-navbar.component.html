<nav class="navbar navbar-dark text-white d-flex align-items-center" [class.navbar-expand-md]="!isMobileLandscape">
  <div class="container-fluid h-100 d-flex align-items-center">
    @if (brandNavitem && !isMobileLandscape) {
    <a class="navbar-brand d-flex align-items-center position-relative main-nav-link align-middle"
      [routerLink]="brandNavitem.path">
      <span class="align-middle">{{ brandNavitem.label }}</span>
    </a>
    }
    <!-- Bouton toggler supprimé ici, il est présent dans la ligne compacte mobile -->

    <!-- Desktop menu (caché en mobile landscape) -->
    @if (!isMobileLandscape) {
    <div class="collapse navbar-collapse navbar-desktop d-none d-md-flex align-items-center position-relative">
      <ul class="navbar-nav me-auto  mb-lg-0">
        <ng-container *ngTemplateOutlet="dyn_navbar_unified; context: { isMobile: false }"></ng-container>
      </ul>
    </div>
    }

    <!-- Sidebar for mobile (toujours dispo en mobile landscape) -->
    <div class="offcanvas offcanvas-start navbar-offcanvas bg-white text-dark"
         [class.d-md-none]="!isMobileLandscape"
         tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header flex-column align-items-start py-1">
        <div class="d-flex w-100 justify-content-between align-items-center ">
          @if (brandNavitem) {
          <a class="dropdown-item fw-bold" [routerLink]="brandNavitem.path" data-bs-dismiss="offcanvas" style="font-size:1.1rem;">
            {{ brandNavitem.label }}
          </a>
          }
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
      </div>
      <div class="offcanvas-body p-1">
        <ul class="navbar-nav">
          <ng-container *ngTemplateOutlet="dyn_navbar_unified; context: { isMobile: true, isPortrait: isPortrait }"></ng-container>
        </ul>
      </div>
    </div>

    <!-- Ligne compacte mobile : toggler + titre (visible en mobile ou en mobile landscape) -->
    @if (isMobileLandscape) {
    <div class="navbar-mobile-compact d-flex align-items-center justify-content-between w-100 py-1 px-2"
         style="background: var(--navbar-bg);">
      <button class="navbar-toggler me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="title-banner text-center flex-grow-1" style="font-size:0.8rem;">Bridge Club Saint-Orens</span>
    </div>
    } @else {
    <div class="navbar-mobile-compact d-md-none d-flex align-items-center justify-content-between w-100 py-1 px-2"
         style="background: var(--navbar-bg);">
      <button class="navbar-toggler me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="title-banner text-center flex-grow-1" style="font-size:0.8rem;">Bridge Club Saint-Orens</span>
    </div>
    }

  </div>
</nav>


<ng-template #dyn_navbar_unified let-isMobile="isMobile">
  @for (menu of navbar_menus; track menu.navitem.id) {
  @if (menu.navitem.position === NAVITEM_POSITION.NAVBAR &&
  ((menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.ANY)
  || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.LOGGED_ONLY && (logged_member$ | async))
  || (menu.navitem.logging_criteria === NAVITEM_LOGGING_CRITERIA.UNLOGGED_ONLY && !(logged_member$ | async)))) {
  <ng-container *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: menu, isMobile: isMobile, isPortrait: isPortrait }"></ng-container>
  }
  }
</ng-template>

<!-- Template récursive unifiée pour MenuGroup -->
<ng-template #menuGroupRecursive let-menu let-isMobile="isMobile">
  @if (menu.navitem.type === NAVITEM_TYPE.DROPDOWN && (menu.childs?.length || 0) > 0) {
    <!-- Desktop ou mobile/landscape: dropdown avec ngbDropdown (non déplié) -->
    @if (!isMobile || (isMobile && !isPortrait)) {
    <li class="nav-item dropdown ms-3" ngbDropdown>
      <a class="nav-link main-nav-link dropdown-toggle" ngbDropdownToggle
        [id]="'nav-' + menu.navitem.id">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        <span>{{ label_transformer(menu.navitem.label) | async }}</span>
      </a>
      <ul class="dropdown-menu" ngbDropdownMenu [attr.aria-labelledby]="'nav-' + menu.navitem.id">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container
          *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: child, isMobile: isMobile }"></ng-container>
        }
      </ul>
    </li>
    }
    <!-- Mobile/portrait: liste dépliée sans dropdown -->
    @else {
    <li class="nav-item mobile-submenu-parent">
      <span class="dropdown-item">
        @if(menu.navitem.pre_label === 'avatar') {
        <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
          style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
        }
        {{ label_transformer(menu.navitem.label) | async }}
      </span>
      <ul class="navbar-nav ms-3">
        @for (child of (menu.childs || []); track child.navitem.id) {
        <ng-container
          *ngTemplateOutlet="menuGroupRecursive; context: { $implicit: child, isMobile: isMobile }"></ng-container>
        }
      </ul>
    </li>
    }
  }
  @else {
  <li [class]="isMobile ? 'nav-item' : 'nav-item ms-3'">
    @if (menu.navitem.type === NAVITEM_TYPE.EXTERNAL_REDIRECT) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" [href]="menu.navitem.extra_parameter"
      target="_blank" rel="noopener" [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.INTERNAL_LINK) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" [routerLink]="menu.navitem.path"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type?.toLowerCase() === 'plugin') {
    <a [class]="isMobile ? 'dropdown-item Plugin' : 'nav-link main-nav-link Plugin'" [routerLink]="menu.navitem.path"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.CUSTOM_PAGE) {
    <a [class]="isMobile ? 'dropdown-item Page' : 'nav-link main-nav-link Page'" [routerLink]="menu.navitem.path"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else if (menu.navitem.type === NAVITEM_TYPE.DIRECT_CALL) {
    <a [class]="isMobile ? 'dropdown-item' : 'nav-link main-nav-link'" (click)="onCommand(menu.navitem)"
      [attr.data-bs-dismiss]="isMobile ? 'offcanvas' : null">
      <ng-container *ngTemplateOutlet="menuLabelTemplate; context: { $implicit: menu }"></ng-container>
    </a>
    }
    @else {
    <span class="dropdown-item text-danger">Type de menu inconnu</span>
    }
  </li>
  }
</ng-template>


<!-- Shared label template for both desktop and mobile -->
<ng-template #menuLabelTemplate let-menu>
  @if(menu.navitem.pre_label === 'avatar') {
  <img [src]="avatar$ | async" alt="avatar" class="rounded-circle"
    style="width:28px; height:28px; max-width:28px; max-height:28px; object-fit:cover">
  }
  {{ label_transformer(menu.navitem.label) | async }}
</ng-template>

<!-- Cache le titre classique sur mobile -->
<style>
  @media (max-width: 767.98px) {
    .navbar .navbar-brand, .navbar .site-banner { display: none !important; }
  }
</style>